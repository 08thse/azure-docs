---
title: Investigate and detect threats for IoT devices | Microsoft Docs
description: This tutorial describes how to use the Microsoft Sentinel data connector and solution for Microsoft Defender for IoT to secure your entire OT environment. Detect and respond to OT threats, including multistage attacks that may cross IT and OT boundaries.
author: batamig
ms.topic: tutorial
ms.date: 09/18/2022
ms.author: bagol
---

# Tutorial: Investigate and detect threats for IoT devices

The integration between Microsoft Defender for IoT and Microsoft Sentinel enable SOC teams to efficiently and effectively detect and respond to Operational Technology (OT) threats. Enhance your security capabilities with the **IoT OT Threat Monitoring with Defender for IoT** solution, a set of bundled content configured specifically for Defender for IoT data that includes analytics rules, workbooks, and playbooks. While Defender for IoT supports both Enterprise IoT and OT networks, the **IoT OT Threat Monitoring with Defender for IoT** solution supports OT networks only.

In this tutorial, you:

> [!div class="checklist"]
>
> * Install the **IoT OT Threat Monitoring with Defender for IoT** solution
> * Learn how to investigate Defender for IoT alerts in Microsoft Sentinel incidents
> * Learn about the analytics rules, workbooks, and playbooks deployed to your Microsoft Sentinel workspace with the Defender for IoT solution

## Prerequisites

Before you start, make sure you have:

- **Read** and **Write** permissions on your Microsoft Sentinel workspace. For more information, see [Permissions in Microsoft Sentinel](roles.md).

- **Contributor** or **Owner** permissions on the subscription you want to connect.

- Completed [Tutorial: Integrate Microsoft Sentinel and Microsoft Defender for IoT](iot-solution.md).

## Install the Defender for IoT solution

Microsoft Sentinel [solutions](sentinel-solutions.md) can help you onboard Microsoft Sentinel security content for a specific data connector using a single process.

The **IoT OT Threat Monitoring with Defender for IoT** integrates Defender for IoT data with Microsoft Sentinel's security orchestration, automation, and response (SOAR) capabilities by providing out-of-the-box and OT-optimized playbooks for automated response and prevention capabilities.

**To install the solution**:

1. In Microsoft Sentinel, under **Content management**, select **Content hub** and then locate the **IoT OT Threat Monitoring with Defender for IoT** solution.

1. At the bottom right, select **View details**, and then **Create**. Select the subscription, resource group, and workspace where you want to install the solution, and then review the related security content that will be deployed.

1. When you're done, select **Review + Create** to install the solution.

For more information, see [About Microsoft Sentinel content and solutions](sentinel-solutions.md) and [Centrally discover and deploy out-of-the-box content and solutions](sentinel-solutions-deploy.md).

## Detect threats out-of-the-box with Defender for IoT data

By default, new incidents in Microsoft Sentinel aren’t created for alerts generated by Defender for IoT data. This procedure describes how to use the built-in analytics rules in the **IoT OT Threat Monitoring with Defender for IoT** solution to ensure that your Microsoft Sentinel instance creates new incidents for relevant alerts.

For more information, see:

- [Detect threats out-of-the-box](detect-threats-built-in.md)
- [Create custom analytics rules to detect threats](detect-threats-custom.md)

**Prerequisites**: Make sure you've [installed the Defender for IoT solution](#install-the-defender-for-iot-solution) to get out-of-the-box analytics rules, built specifically for Defender for IoT data, deployed to your workspace.

The following table describes the out-of-the-box analytics rules provided in the [IoT OT Threat Monitoring with Defender for IoT](#install-the-defender-for-iot-solution) solution.

> [!TIP]
> When working with the following analytics rules, we recommend that you turn off the default *Microsoft Security* Defender for the IoT analytics rules.
>

| Rule Name | Description|
| ---------- | ----------|
| **Illegal function codes for ICS/SCADA traffic** | Illegal function codes in supervisory control and data acquisition (SCADA) equipment may indicate one of the following: <br><br>- Improper application configuration, such as due to a firmware update or reinstallation. <br>- Malicious activity. For example, a cyber threat that attempts to use illegal values within a protocol to exploit a vulnerability in the programmable logic controller (PLC), such as a buffer overflow.              |
| **Firmware update**      | Unauthorized firmware updates may indicate malicious activity on the network, such as a cyber threat that attempts to manipulate PLC firmware to compromise PLC function.    |
| **Unauthorized PLC changes**                     | Unauthorized changes to PLC ladder logic code may be one of the following: <br><br>- An indication of new functionality in the PLC. <br>- Improper configuration of an application, such as due to a firmware update or reinstallation. <br>- Malicious activity on the network, such as a cyber threat that attempts to manipulate PLC programming to compromise PLC function.          |
| **PLC insecure key state**                      | The new mode may indicate that the PLC is not secure. Leaving the PLC in an insecure operating mode may allow adversaries to perform malicious activities on it, such as a program download. <br><br>If the PLC is compromised, devices and processes that interact with it may be impacted. which may affect overall system security and safety.      |
| **PLC stop**  | The PLC stop command may indicate an improper configuration of an application that has caused the PLC to stop functioning, or malicious activity on the network. For example, a cyber threat that attempts to manipulate PLC programming to affect the functionality of the network.       |
| **Suspicious malware found in the network**      | Suspicious malware found on the network indicates that suspicious malware is trying to compromise production.    |
| **Multiple scans in the network**                | Multiple scans on the network can be an indication of one of the following: <br><br>- A new device on the network <br>- New functionality of an existing device <br>- Misconfiguration of an application, such as due to a firmware update or reinstallation <br>- Malicious activity on the network for reconnaissance    |
| **Internet connectivity**                        | An OT device communicating with internet addresses may indicate an improper application configuration, such as anti-virus software attempting to download updates from an external server, or malicious activity on the network.     |
| **Unauthorized device in the SCADA network**     | An unauthorized device on the network may be a legitimate, new device recently installed on the network, or an indication of unauthorized or even malicious activity on the network, such as a cyber threat attempting to manipulate the SCADA network.  |
| **Unauthorized DHCP configuration in the SCADA network**    | An unauthorized DHCP configuration on the network may indicate a new, unauthorized device operating on the network. <br><br>This may be one a legitimate, new device recently deployed on the network, or an indication of unauthorized or even malicious activity on the network, such as a cyber threat attempting to manipulate the SCADA network. |
| **Excessive login attempts**                     | Excessive sign in attempts may indicate improper service configuration, human error, or malicious activity on the network, such as a cyber threat attempting to manipulate the SCADA network.  |
| **High bandwidth in the network**                | An unusually high bandwidth may be an indication of a new service/process on the network, such as backup, or an indication of malicious activity on the network, such as a cyber threat attempting to manipulate the SCADA network.     |
| **Denial of Service**    | This alert detects attacks that would prevent the use or proper operation of the DCS system.         |
| **Unauthorized remote access to the network**    | Unauthorized remote access to the network can compromise the target device. <br><br> This means that if another device on the network is compromised, the target devices can be accessed remotely, increasing the attack surface.         |
| **No traffic on Sensor Detected**    | A sensor that no longer detects network traffic indicates that the system may be insecure.         |

### Alternate options for triggering incidents from Defender for IoT data

The following alternative options are available for you to ensure that incidents are triggered for Defender for IoT data in Microsoft Sentinel:

- Manually create and manage analytics rules in the Microsoft Sentinel **Analytics > Active rules** page. For example, use this option to use the out-of-the box analytics rules as templates for customized rules, or to configure analytics rules for scenarios not yet covered by the solution. For more information, see [Detect threats out-of-the-box](detect-threats-built-in.md).

- Configure the **Defender for IoT** data connector to automatically create incidents for *all* alerts generated by Defender for IoT. In the **Instructions** tab of the data connector page, scroll down to the **Create incidents** section and select **Enable**.

    > [!CAUTION]
    > This option may cause a large number of incidents to be created in your workspace.
    >

## Investigate Defender for IoT incidents

After you’ve [configured your Defender for IoT data to trigger new incidents in Microsoft Sentinel](#detect-threats-out-of-the-box-with-defender-for-iot-data), start investigating those incidents in Microsoft Sentinel as you would other incidents.

**To investigate Microsoft Defender for IoT incidents**:

1. In Microsoft Sentinel, go to the **Incidents** page.

1. Above the list of incidents, select the **Product name** filter, clear all selections and then select **Microsoft Defender for IoT** to view incidents triggered by Defender for IoT alerts.

1. Select a specific incident to begin your investigation.

    In the incident details pane on the right, view details such as incident severity, a summary of the entities involved, any mapped MITRE ATT&CK tactics or techniques, and more.

To investigate further, do one or both of the following:

- Select an entity from the **Entities** list in the incident details pane to open an IoT device's entity page. For example:
        
    :::image type="content" source="media/iot-solution/investigate-iot-incidents.png" alt-text="Screenshot of a Microsoft Defender for IoT incident in Microsoft Sentinel.":::

     The IoT device entity page provides contextual device information, including basic device details and device owner contact information, and helps to prioritize remediation based on device importance and business impact per the alert site, zone, and sensor.
    
    For more information on entity pages, see [Investigate entities with entity pages in Microsoft Sentinel](entity-pages.md).

- Hunt for vulnerable devices on the **Entity behavior** page. For example, view the top five IoT devices with the highest number of alerts, or search for a device by IP address or device name.

For more information on how to investigate incidents and use the investigation graph, see [Investigate incidents with Microsoft Sentinel](investigate-cases.md).

> [!TIP]
> To investigate the incident in Defender for IoT, select the **Investigate in Microsoft Defender for IoT** link in an incident details pane.

## Visualize and monitor Defender for IoT data

To visualize and monitor your Defender for IoT data, use the workbooks deployed to your Microsoft Sentinel workspace as part of the [IoT OT Threat Monitoring with Defender for IoT](#install-the-defender-for-iot-solution) solution.

The Defender for IoT workbooks provide guided investigations for OT entities based on open incidents, alert notifications, and activities for OT assets. They also provide a hunting experience across the MITRE ATT&CK® framework for ICS, and are designed to enable analysts, security engineers, and MSSPs to gain situational awareness of OT security posture.

View workbooks in Microsoft Sentinel on the **Threat management > Workbooks > My workbooks** tab. For more information, see [Visualize collected data](get-visibility.md).

The following table describes the workbooks included in the **IoT OT Threat Monitoring with Defender for IoT** solution:

|Workbook  |Description  |Logs  |
|---------|---------|---------|
|**Overview**     | Dashboard displaying a summary of key metrics for device inventory, threat detection and vulnerabilities.         |    Uses data from Azure Resource Graph (ARG)      |
|**Device Inventory**     | Displays data such as: OT device name, type, IP address, Mac address, Model, OS, Serial Number, Vendor, Protocols, Open alerts, and CVEs and recommendations per device.  Can be filtered by site, zone, and sensor.       |    Uses data from Azure Resource Graph (ARG)      |
|**Incidents**     |   Displays data such as: <br><br>- Incident Metrics, Topmost Incident, Incident over time, Incident by Protocol, Incident by Device Type, Incident by Vendor, and Incident by IP address.<br><br>- Incident by Severity, Incident Mean time to respond, Incident Mean time to resolve and Incident close reasons.       |   Uses data from the following log: SecurityAlert       |
|**Alerts**     |  Displays data such as: Alert Metrics, Topmost Alerts, Alert over time, Alert by Severity, Alert by Engine, Alert by Device Type, Alert by Vendor and Alert by IP address.         |    Uses data from Azure Resource Graph (ARG)     |
|**MITRE ATT&CK® for ICS**     |   Displays data such as: Tactic Count, Tactic Details, Tactic over time, Technique Count.        |   Uses data from the following log: SecurityAlert       |
|**Vulnerabilities**     | Displays vulnerabilities and CVEs for vulnerable devices. Can be filtered by size and severity.         |    Uses data from Azure Resource Graph (ARG)      |

## Automate response to Defender for IoT alerts

Playbooks are collections of automated remediation actions that can be run from Microsoft Sentinel as a routine. A playbook can help automate and orchestrate your threat response; it can be run manually or set to run automatically in response to specific alerts or incidents, when triggered by an analytics rule or an automation rule, respectively.

The playbooks described in the following sections are deployed to your Microsoft Sentinel workspace as part of the [IoT OT Threat Monitoring with Defender for IoT](#install-the-defender-for-iot-solution) solution.

For more information, see:

- [Tutorial: Use playbooks with automation rules in Microsoft Sentinel](tutorial-respond-threats-playbook.md)
- [Automate threat response with playbooks in Microsoft Sentinel](automate-responses-with-playbooks.md)

### Playbook prerequisites

This procedure is required for the [AD4IoT-AutoAlertStatusSync](#update-alert-statuses-in-defender-for-iot),
[AD4IoT-CVEAutoWorkflow](#automate-workflows-for-incidents-with-active-cves), [AD4IoT-SendEmailtoIoTOwner](#send-email-to-the-iotot-device-owner), and [AD4IoT-AutoTriageIncident](#triage-incidents-involving-highly-important-devices) playbooks only. Details will differ for each playbook, but the main steps remain the same.

**To add the required role to the Azure subscription where the playbook is installed**:

1. In Microsoft Sentinel, open the playbook from **Automation** > **Active playbooks**. 

1. Select a playbook to open it as a Logic app.

1. With the playbook opened as a Logic app, select **Identity > System assigned**, and then in the **Permissions** area, select the **Azure role assignments** button.

1. In the **Azure role assignments** page, select **Add role assignment**.

1. In the **Add role assignment** pane:

    - Define the **Scope** as **Subscription**.
    
    - From the dropdown, select the **Subscription** where your playbook is installed.
    
    - From the **Role** dropdown, select one of the following roles, depending on the playbook you’re working with:
    
        |Playbook name  |Role  |
        |---------|---------|
        |[AD4IoT-AutoAlertStatusSync](#update-alert-statuses-in-defender-for-iot)  |Security Admin  |
        |[AD4IoT-CVEAutoWorkflow](#automate-workflows-for-incidents-with-active-cves)  |Reader  |
        |[AD4IoT-SendEmailtoIoTOwner](#send-email-to-the-iotot-device-owner)  |Reader  |
        |[AD4IoT-AutoTriageIncident](#triage-incidents-involving-highly-important-devices)  |Reader  |

1. When you're done, select **Save**. 

**To ensure that you have valid connections for each of your connection steps in the playbook**:

1. In Microsoft Sentinel, open the playbook from **Automation** > **Active playbooks**.

1. Select a playbook to open it as a Logic app.

1. With the playbook opened as a Logic app, select **Logic app designer**. Expand each step in the logic app to check for invalid connections, which are indicated by an orange warning triangle. Invalid connections may be hiding inside other steps. For example:

    :::image type="content" source="media/iot-solution/connection-steps.png" alt-text="Screenshot of the default AD4IOT AutoAlertStatusSync playbook." lightbox="media/iot-solution/connection-steps.png"::: 

1. Select **Save**. 

**Connect your incidents, relevant analytics rules, and the playbook**:

Add a new Microsoft Sentinel analytics rule, defined as follows:

1. In Microsoft Sentinel, go to **Automation** > **Automation rules**.

1. To create a new automation rule, select **Create** > **Automation rule**.

1. In the **Trigger** field, select one of the following triggers, depending on the playbook you’re working with:

    |Playbook name  |Trigger  |
    |---------|---------|
    |[AD4IoT-AutoAlertStatusSync](#update-alert-statuses-in-defender-for-iot)  |When an incident is updated  |
    |[AD4IoT-CVEAutoWorkflow](#automate-workflows-for-incidents-with-active-cves)  |When an incident is created  |
    |[AD4IoT-SendEmailtoIoTOwner](#send-email-to-the-iotot-device-owner)  |When an incident is created  |
    |[AD4IoT-AutoTriageIncident](#triage-incidents-involving-highly-important-devices)  |When an incident is created  |

1. In the **Conditions** area, select **If > Analytic rule name > Contains**, and then select the specific analytics rules relevant for Defender for IoT in your organization.

    For example:

    :::image type="content" source="media/iot-solution/automate-playbook.png" alt-text="Screenshot of a Defender for IoT alert status sync automation rule." lightbox="media/iot-solution/automate-playbook.png":::

    You may be using out-of-the-box analytics rules, or you may have modified the out-of-the-box content, or created your own. For more information, see [Detect threats out-of-the-box with Defender for IoT data](#detect-threats-out-of-the-box-with-defender-for-iot-data).

1. In the **Actions** area, select **Run playbook** > *playbook name*.

1. Select **Run**.



> [!TIP]
> You can also manually run a playbook on demand. This can be useful in situations where you want more control over orchestration and response processes. For more information, see [Run a playbook on demand](tutorial-respond-threats-playbook.md#run-a-playbook-on-demand).

###  Automatically close incidents

**Playbook name**: AD4IoT-AutoCloseIncidents

In some cases, maintenance activities generate alerts in Microsoft Sentinel that can distract a SOC team from handling the real problems. This playbook automatically closes incidents created from such alerts during a specified maintenance period, explicitly parsing the IoT device entity fields.

To use this playbook:

- Enter the relevant time period when the maintenance is expected to occur, and the IP addresses of any relevant assets, such as listed in an Excel file.
- Create a watchlist that includes all the asset IP addresses on which alerts should be handled automatically.

### Send email notifications by production line

**Playbook name**: AD4IoT-MailByProductionLine

This playbook sends mail to notify specific stakeholders about alerts and events that occur in your environment.

For example, when you have specific security teams assigned to specific product lines or geographic locations, you'll want that team to be notified about alerts that are relevant to their responsibilities.

To use this playbook, create a watchlist that maps between the sensor names and the mailing addresses of each of the stakeholders you want to alert.

### Create a new ServiceNow ticket

**Playbook name**: AD4IoT-NewAssetServiceNowTicket

Typically, the entity authorized to program a PLC is the Engineering Workstation. Therefore, attackers might create new Engineering Workstations in order to create malicious PLC programming.

This playbook opens a ticket in ServiceNow each time a new Engineering Workstation is detected, explicitly parsing the IoT device entity fields.

### Update alert statuses in Defender for IoT

**Playbook name**: AD4IoT-AutoAlertStatusSync

**Prerequisites**: Make sure to complete the [playbook prerequisite procedure](#playbook-prerequisites) when using this playbook.

This playbook updates alert statuses in Defender for IoT whenever a related alert in Microsoft Sentinel has a **Status** update.

This synchronization overrides any status defined in Defender for IoT, in the Azure portal or the sensor console, so that the alert statuses match that of the related incident.

### Automate workflows for incidents with active CVEs

**Playbook name**: AD4IoT-CVEAutoWorkflow

**Prerequisites**: Make sure to complete the [playbook prerequisite procedure](#playbook-prerequisites) when using this playbook.

This playbook adds active CVEs into the incident comments of affected devices. An automated triage is performed if the CVE is critical, and an email notification is sent to the device owner, as defined on the site level in Defender for IoT.

To add a device owner, edit the site owner on the **Sites and sensors** page in Defender for IoT. For more information, see [Site management options from the Azure portal](../defender-for-iot/organizations/how-to-manage-sensors-on-the-cloud.md#site-management-options-from-the-azure-portal).

### Send email to the IoT/OT device owner

**Playbook name**: AD4IoT-SendEmailtoIoTOwner

**Prerequisites**: Make sure to complete the [playbook prerequisite procedure](#playbook-prerequisites) when using this playbook.

This playbook sends an email with the incident details to the device owner as defined on the site level in Defender for IoT, so that they can start investigating, even responding directly from the automated email. Response options include:

- **Yes this is expected**. Select this option to close the incident.

- **No this is NOT expected**. Select this option to keep the incident active, increase the severity, and add a confirmation tag to the incident.

The incident is automatically updated based on the response selected by the device owner.

To add a device owner, edit the site owner on the **Sites and sensors** page in Defender for IoT. For more information, see [Site management options from the Azure portal](../defender-for-iot/organizations/how-to-manage-sensors-on-the-cloud.md#site-management-options-from-the-azure-portal).

### Triage incidents involving highly important devices

**Playbook name**: AD4IoT-AutoTriageIncident

**Prerequisites**: Make sure to complete the [playbook prerequisite procedure](#playbook-prerequisites) when using this playbook.

This playbook updates the incident severity according to the importance level of the devices involved.

## Next steps

For more information, see:

- [Investigate incidents with Microsoft Sentinel](investigate-cases.md)
- [Investigate entities with entity pages in Microsoft Sentinel](entity-pages.md)
- [Visualize collected data](get-visibility.md)
- [Tutorial: Use playbooks with automation rules in Microsoft Sentinel](tutorial-respond-threats-playbook.md)
- [Defending Critical Infrastructure with the Microsoft Sentinel: IT/OT Threat Monitoring Solution](https://techcommunity.microsoft.com/t5/microsoft-sentinel-blog/defending-critical-infrastructure-with-the-microsoft-sentinel-it/ba-p/3061184)
- [Microsoft Defender for IoT documentation](../defender-for-iot/index.yml)
- [Microsoft Defender for IoT solution](sentinel-solutions-catalog.md#microsoft)
