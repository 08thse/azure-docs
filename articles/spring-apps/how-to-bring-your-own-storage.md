# Bring Your Own Storage to Azure Spring Apps

When you use the built-in persistent storage in Azure Spring Apps, artifacts generated by your application are uploaded into Azure Storage Accounts. Microsoft controls the encryption-at-rest and lifetime management policies for those artifacts.

When you use your own persistent storage, artifacts generated by your application are uploaded into a storage account that you control. You control the encryption-at-rest policy, the lifetime management policy, and network access. Since your Azure Spring Apps instance is deployed on a Managed Environment, your can mount your own persistent storage to not only Azure Spring Apps but other instances on this managed environment like Azure Container Apps.

This article shows you how to enable your own persistent storage in Azure Spring Apps.

## Prerequisites

- Finish a previous doc about [Create Azure Spring Apps Consumption Plan (Standard Gen2)](./create-asa-standard-gen2.md)
- Finish a previous doc about [Build and deploy Spring apps](./create-and-deploy-apps.md).

## Step 1: Set up the environment

This step help you define the variables, some of them are from the previous doc [Create Azure Spring Apps Consumption Plan (Standard Gen2)](./create-asa-standard-gen2.md), please customize the values if needed.

```bash
    RESOURCE_GROUP="my-spring-apps"
    LOCATION="eastus"
    MANAGED_ENVIRONMENT="my-environment"
    SPRING_APPS_NAME="my-spring-apps-instance"
    APP_NAME="my-spring-app"
```

## Step 1: Set up a storage account

The first step is to create a storage account and establish a file share to mount to the spring app.

1. Define a storage account name

This command generates a random suffix to the storage account name to ensure uniqueness.

```azurecli
STORAGE_ACCOUNT_NAME="myacastorageaccount$RANDOM"
```

2. Create an Azure Storage account

```azurecli
az storage account create \
  --resource-group $RESOURCE_GROUP \
  --name $STORAGE_ACCOUNT_NAME \
  --location "$LOCATION" \
  --kind StorageV2 \
  --sku Standard_LRS \
  --enable-large-file-share \
  --query provisioningState
```

Once created, the command should return a "Succeeded" message.

3. Define a file share name

```bash
FILE_SHARE_NAME="myfileshare"
```

4. Create the Azure Storage file share

```azurecli
az storage share-rm create \
  --resource-group $RESOURCE_GROUP \
  --storage-account $STORAGE_ACCOUNT_NAME \
  --name $FILE_SHARE_NAME \
  --quota 1024 \
  --enabled-protocols SMB \
  --output table
```

5. Get the Storage Account key

```bash
STORAGE_ACCOUNT_KEY=`az storage account keys list -n $STORAGE_ACCOUNT_NAME --query "[0].value" -o tsv`
```

The storage account key is required to create the storage link in your Container Apps environment.

## Step 2: Link the storage to the managed environment

1. Define the storage mount name

```bash
STORAGE_MOUNT_NAME="mystoragemount"
```

2. Create the storage link in the managed environment

```azurecli
az containerapp env storage set \
  --access-mode ReadWrite \
  --azure-file-account-name $STORAGE_ACCOUNT_NAME \
  --azure-file-account-key $STORAGE_ACCOUNT_KEY \
  --azure-file-share-name $FILE_SHARE_NAME \
  --storage-name $STORAGE_MOUNT_NAME \
  --name $MANAGED_ENVIRONMENT \
  --resource-group $RESOURCE_GROUP \
  --output table
```

This command creates a link between container app environment and the file share created with the az storage share-rm command.

Now that the storage account and environment are linked, you can use the storage mount in your Azure Spring Apps.

## Step 3: 

Add the persistent storage to your existing app.

```azurecli
az spring app append-persistent-storage \
    --resource-group $RESOURCE_GROUP \
    --service $SPRING_APPS_NAME \
    --name $APP_NAME \
    --persistent-storage-type AzureFileVolume \
    --mount-path /var/log/nginx \
    --storage-name STORAGE_MOUNT_NAME
```