---
title: How to configure Azure Functions with identity based connections
description: Article that shows you how to use identity based connections with Azure Functions instead of connection strings
ms.topic: conceptual
ms.date: 3/13/2021
ms.custom: template-how-to #Required; leave this attribute/value as-is.
---

# Creating a Function App with Identity Based Connections

This article shows you how to configure your function app to use identity based connections instead of connection strings. To learn more about identity based connections, see [Configure an identity-based connection.](functions-reference.md#configure-an-identity-based-connection).

# Creating a Secretless Function App using Managed Identity

My goal is to make a fully secretless function app, and then add triggers for an Azure Storage queue and a Service Bus queue.

## Step 1: Create the Function App without Azure Files

The first step is to create the function app, and configure it without Azure Files (because Azure Files doesn't support managed identity for SMB file shares). There is some documentation on this [here](https://docs.microsoft.com/en-us/azure/azure-functions/storage-considerations#create-an-app-without-azure-files). The portal doesn't provide that option today, but I can take the ARM template generated by the portal and modify it for my needs. So I go the through the create wizard, but instead of hitting Create, I  hit the template button:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624643669394.png)

This brings up the following screen. I select deploy:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624643719004.png)

But I'm not actually deploying yet! First I'll edit:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624643739397.png)

In the editor, I'm removing the two Azure Files settings WEBSITE_CONTENTAZUREFILECONNECTIONSTRING and WEBSITE_CONTENTSHARE 

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624643762911.png)

I then save my changes and go back to the deploy UX. I made sure the right parameters are selected (I had to re-enter my resource group), and then review+ create and then create.

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624643782969.png)

I wait for the function app to finish deployment, and then I go open it in the portal. The first thing I notice is a warning about storage. That’s expected because I removed azure files. It will go away once I setup run-from-package.

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624643841437.png)

## Step 2: Enable Managed Identity

To start making this app secretless, I have to enable managed identity. For this walkthrough I'm using the system assigned identity. The documentation on this topic is [here](https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=dotnet). I select identity, pick the system assigned tab, and turn it on:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624643879605.png)

Now I am going to start adding role assignments. I want this function app to be able to access blob content in its storage account without a key so I make this role assignment using the Azure role assignments button in the above screenshot.

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624643910588.png)

Note - Storage Blob Data Contributor is likely a better role as its scope is more limited. The docs will be likely updated to recommend this role the future.

This will also allow me to use managed identity to pull the package from this blob account, so when I configure run-from-package I won't need to use a SAS.

## Step 3: Deploy a function using Run From Package

Lets prepare the package. I'll start with just a timer triggered function to keep things simple and confirm I configured things correctly so that I don’t need any secrets for AzureWebJobsStorage. So I go into VS, create a new V3 function app and select timer trigger:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624643938033.png)

I right click the project and select publish, but VS doesn't know how to publish a package to blob. I'll need to do that manually. So I select the folder profile and hit publish:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624643956200.png)

I go to the filesystem and zip the output:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624643974521.png)

I then go to the storage account that is associated with this function app (the one I added Storage Blob Data Owner for), create a container for my packages, and then upload the package:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644006495.png)

I then go to the blob properties and grab the URL:
![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644026289.png)

Now I switch back to the function app, go to its configuration and add the WEBSITE_RUN_FROM_PACKAGE appsetting and paste in the URL. The run-from-package feature is documented [here](https://docs.microsoft.com/en-us/azure/azure-functions/run-functions-from-deployment-package).

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644050838.png)

Next I want to confirm that my function app is able to load the package. The easiest way to do this is to go to the functions list. I should be able to see the timer triggered function, and run it:
![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644074397.png)

It works! 

## Step 4: Use Managed Identity for AzureWebJobsStorage

The next step is to switch AzureWebJobsStorage to be secretless. This should already work because the function app has the Storage Blob Data Owner role. To do this, I just need to specify the account name. So I rename the setting to AzureWebJobsStorage__accountName and leave just the account name in the value:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644225349.png)

I confirm the timer is still running after making this change and I'm done. I've successfully removed the secrets in my function app by configuring it without Azure Files, and using managed identity to load the application content from blob storage using run-from-package.

Next up, some optional steps.

## Optional Step A: Use Managed Identity to access Key Vault

There's one more key-like setting in my Function App, and that’s my App Insights connection string. Now this is not technically a secret (it contains the instrumentation key, which is not always protectable - see here), but I thought it would be an educational exercise to move this setting to Key Vault and used managed identity to access it. 

First I created a Key Vault, and add the secret. I call the secret "AppInsights" and paste in the connection string for the value.

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644364950.png)

I then switch the Key Vault over to use Azure role-based access control:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644413549.png)

I then add a role assignment in my Function App to give it Key Vault Secrets User:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644434000.png)

Now I can use a Key Vault reference in my application settings. Documentation for that is [here](https://docs.microsoft.com/en-us/azure/app-service/app-service-key-vault-references).

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644494384.png)

I switch over to App Insights, open live metrics, and confirm that my Key Vault reference is working and my data is still flowing. Everything seems to be working fine:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644527788.png)

The Function App is now fully secretless, but it currently only has a timer trigger i.e. its not being triggered by an external source. That’s what I'll cover next. But first, a screenshot of the appsettings in my app with nothing redacted, because there's no secrets:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644561613.png)

## Optional Step B: Add a Storage Queue Trigger

Lets add a storage queue trigger. I'm going to assume that I already have this queue data somewhere else, so I'm going to create a new storage account to represent that. I then go into the role assignments for the function app and add the Storage Queue Data Contributor role for this new storage account:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644797808.png)

I make sure to update my storage extension to 5.x. This is the new storage extension for functions that uses the newest version of the Azure Storage SDK for .NET. There was a blog post about that here. At the time of writing, the newest version of the library is 5.0.0-beta4:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644809684.png)

This queue trigger uses a connection called "QueueConnection", so I need to configure the function app with the account name, similar to what I did above for AzureWebJobsStorage:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644829790.png)

I'm also using an environment variable for the name of the queue within the account (InputQueueName in the above screenshot), but its just a convenience and not necessary.

For every connection that is used as a trigger, I must also add the credential setting that specifies that managed identity is used. So I add a `QueueConnection_credential` setting with value `managedIdentity`.

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624658524131.png)

A future update to Azure Functions will remove this requirement when using system assigned identities. Once this update is live, simply setting __accountName would be enough.

My function app has been updated to have the necessary role to access the queue using managed identity, and its been configured to know what account to access, and it has a queue triggered function that uses the new extension that has support for managed identity. The only remaining step is to publish the changes. I repeat the folder publishing step, zip the content, upload it to storage calling it "queue.zip" and update my run from package URL:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644849689.png)

Now I go to the queue in the portal, and I add a message:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644858600.png)

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644866344.png)

I wait a bit and then refresh and the message has been read:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644879341.png)

## Optional Step C: Add a Service Bus Queue Trigger

Again I start with role assignments, adding the function app as a Azure Service Bus Data Owner:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624644967309.png)

I have to configure the function app with the details of the namespace. My connection is going to be called ServiceBusConnection so I add a ServiceBusConnection__fullyQualifiedNamespace setting:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624645004512.png)

For every connection that is used as a trigger, I must also add the credential setting that specifies that managed identity is used. So I add a `ServiceBusConnection_credential` setting with value `managedIdentity`.

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624659002007.png)

I add a service bus queue triggered function, again making sure to use the newest extension which is Microsoft.Azure.WebJobs.Extensions.ServiceBus version 5.0.0-beta4 at time of writing:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624645067952.png)

I go through similar publish steps as before. Here's my appsettings now:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624645077874.png)

## Optional Step D: Use Managed Identity for local development

To test the service bus trigger I added above, I need to drop a message in the service bus queue, but the portal won't let me do that. There are plenty of other ways to write a message to a service bus queue, but this seems like a good opportunity to try using managed identity locally. First I go into VS and make sure that its configured to use my account:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624645133535.png)

Next I go into the portal and give myself the Azure Service Bus Data Owner role - the same as what I did for my function app above:
![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624645150828.png)

Now I make a separate function app that is going to host a HTTP triggered function that uses an output binding to write to the queue. Again, making sure to use the newest extension package:
![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624645164664.png)

I modify my local.settings.json so that my local environment knows which namespace and queue the message has to be written to:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624645198975.png)

I then set this function app as my startup project and hit F5. It outputs the URL for my function, and I call it using my browser:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624645244319.png)

Without configuring any connection string, my local debug session is able to write the message to the queue, and then I check app insights and I see my function ran and picked up the message:

![image](https://gist.github.com/paulbatum/c301e8ca07b2561db91030a1566383fa/raw/images---Fri_Jun_25_2021_1624645272006.png)

This concludes the walkthrough.

## Notes on Event Hubs and Blob Trigger

You can follow similar steps for Event Hubs and Blob trigger. Event Hubs would follow the same patterns as Service Bus, while blob is a little more complicated. The functions host uses queues internally to run the blob trigger, so you would need to make sure that the function app has both blob and queue role assignments, for both the account that is configured for AzureWebJobsStorage, and the account that contains the blobs you're triggering on.

## Links
[Managed identity in Azure Functions](https://docs.microsoft.com/en-us/azure/app-service/overview-managed-identity?tabs=dotnet)

[Identity based connections in Azure Functions](https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference#configure-an-identity-based-connection)

[Connecting to host storage with an Identity](https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference#connecting-to-host-storage-with-an-identity)

[Creating a Function App without Azure Files](https://docs.microsoft.com/en-us/azure/azure-functions/storage-considerations#create-an-app-without-azure-files)

[Run Azure Functions from a package file](https://docs.microsoft.com/en-us/azure/azure-functions/run-functions-from-deployment-package)

[Use Key Vault references in Azure Functions](https://docs.microsoft.com/en-us/azure/app-service/app-service-key-vault-references)

[Azure SDK blog post about the new extensions](https://devblogs.microsoft.com/azure-sdk/introducing-the-new-azure-function-extension-libraries-beta/)

[Configuring the account used by Visual Studio for local development](https://docs.microsoft.com/en-us/dotnet/api/overview/azure/identity-readme#authenticating-via-visual-studio)

[Functions documentation for local development](https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference#local-development)

[GitHub issue were this scenario is discussed](https://github.com/Azure/azure-functions-host/issues/6423)
## Next steps

> [!div class="nextstepaction"]
> [Azure Functions networking options](functions-networking-options.md)

