# Azure Purview Metadata Policy & Metadata Roles APIs: Quickstart Tutorial – Manage Fine Grained Access Control over Purview Collections

In August 2021, Azure Purview moved to support authorization & access control from IAM (control plane) to Azure Purview [Collections](https://docs.microsoft.com/en-us/azure/purview/how-to-create-and-manage-collections) (data plane). This article talks about managing fine grained access control over these collections to users, groups or service principals within your enterprise via Purview APIs. This is an alternative method as against using the Azure Portal or Purview Studio to achieve the same.

# **Table of Contents**

[A. Metadata Policy API Reference Summary](#_Toc82049408)

[B. Tutorial: Create Collection Hierarchy using Azure Portal or APIs.](#_Toc82049409)

[C. Policy JSON Description](#_Toc82049410)

[D. Tutorial: How to add or remove a user, group or service principal to a root collection](#_Toc82049411)

[D1.	API: Get All Metadata Roles](#_Toc82049412)

[Default Metadata Roles](#_Toc82049413)

[D2.	API: Get All Metadata Policies](#_Toc82049414)

[D3.	Get Metadata Policy](#_Toc82049415)

[D3A. Get MetadataPolicy of the collection by collectionName](#_Toc82049416)

[D3B. Get MetadataPolicy of the collection by policyID](#_Toc82049417)

[D4.	API: Update Policy: Add / Remove User, Group, Or Service Principal to Collection](#_Toc82049418)

[D5.	How to remove a service principal to a root collection as Collection Administrator](#_Toc82049419)

[D6.	How to add root collection admin using management API](#_Toc82049420)

[E. MetadataPolicy & MetadataRoles API Reference](#_Toc82049421)


# Metadata Policy API Reference Summary
This table gives an overview of the Collections & Metadata Policy APIs.


|**API Function**|**REST Method**|**API Endpoint**|**Description**|
| :- | :- | :- | :- |
|readMetadataRoles|GET|https://{your-purview-account-name}.purview.azure.com/policystore/metadataroles|Reads all metadata roles from your purview account|
|readMetadataPolicyByCollection|GET|https://{your-purview-account-name}.purview.azure.com/policystore/collections/{collectionName}/metadataPolicy|Reads MetadataPolicy by a given collection name (not friendly/display name but the name generated by Purview while creating the policy)|
|readMetadataPolicyByPolicyID|GET|https://{your-purview-account-name}.purview.azure.com/policystore/metadataPolicies/{policyId}|Reads MetadataPolicy by a given PolicyID. Policy ID is in GUID format.|
|readAllMetadataPolicies|GET|https://{your-purview-account-name}.purview.azure.com/policystore/metadataPolicies|Reads all metadata policies from your purview account. You can pick a certain policy to work with from the JSON output list emitted by this API.|
|putMetadataPolicy|PUT|https://{your-purview-account-name}.purview.azure.com/policystore/metadataPolicies/{policyId}|Updates MetadataPolicy by a given PolicyID. Policy ID is in GUID format.|

# Tutorial: Create Collection Hierarchy using Azure Portal or APIs.	
**Using APIs:**

API: PUT [https://{your-purview-account-name}.purview.azure.com/collections/collectiontest?api-version=2019-11-01-preview](https://hoc-purviewga1.purview.azure.com/collections/collectiontest?api-version=2019-11-01-preview)

Note: If using API, the above API is part of account data plane and the Service Principal (SP), User or Group executing the API should have ‘Collection Admin’ role assigned in Purview to execute this API successfully.

**Using Azure Portal / Purview Studio:**

If a collection is created using Azure Portal Web UI, the “name” of the collection will be different from display name “friendlyName” as purview generates a unique alphanumeric “name” behind the scenes.  If using APIs, then the name and friendly name will be same. For policy APIs you will need name (and not display/friendly name).

Sample Collection Created via Azure Portal: 

```json
{
    "name": "74dhe7", 
    "friendlyName": "Friendly Name",
    "parentCollection": {
        "type": "CollectionReference",
        "referenceName": "{your-purview-account-name}"
    },
    "systemData": {
        "createdBy": "{guid}",
        "createdByType": "Application",
        "createdAt": "2021-08-26T21:21:51.2646627Z",
        "lastModifiedBy": "7f8d47e2-330c-42f0-8744-fcfb1ecb3ea0",
        "lastModifiedByType": "Application",
        "lastModifiedAt": "2021-08-26T21:21:51.2646628Z"
    },
    "collectionProvisioningState": "Succeeded"
}
```
Note: 1) See that the name is a 6 character alphanumeric internal code generated by purview. friendlyName is the readable format which is the collection name displayed on the Purview portal.
Note: 2) If using API, the above API is part of account data plane and the Service Principal (SP), User or Group executing the API should have ‘Collection Admin’ role assigned in Purview to execute this API successfully.

# Policy JSON Description
Details on some of the important identifiers in the JSON output received from the Collection APIs.

**Name**: Name of the policy. 

**Id**: Unique identifier for the policy

**Version**: latest version number of the policy. \*\*(Version number gets incremented each time Update-Metadata-Policy API is called. So, it is necessary to fetch the latest copy of the policy all the time. To achieve this, you must call Get-Policy-by-Policy-ID API every time before updating it, so that you always have the latest version of the JSON)

**DecisionRules**:  List the rules and effect of this policy. For metadata polices, the effect is always “Permit”.

# Tutorial: How to add or remove a user, group or service principal to a root collection as one of the 4 built-in Metadata Roles [Collection Administrator, Data Source Administrator, Data Curator or Data Reader]

1. ## API: Get All Metadata Roles
**GET [https://{your-purview-account-name}.purview.azure.com/policystore/metadataroles?api-version=2021-07-01**]()**

Lists all the Metadata Access Permission Roles available.

The output JSON will generally signify the roles and permissions in this format

### Default Metadata Roles

|**Role ID**|**Permissions**|**Role Description**|
| :- | :- | :- |
|purviewmetadatarole\_builtin\_data-source-administrator|Microsoft.Purview/accounts/scan/read|Grants access to others to read, write collection, register data sources and trigger scans.|
||Microsoft.Purview/accounts/scan/write||
||Microsoft.Purview/accounts/collection/read||
|purviewmetadatarole\_builtin\_collection-administrator|Microsoft.Purview/accounts/collection/read|Admin level full access to entire collection, including add, remove users and SPNs to the collection, management rights, grant and revoke access. In some cases, collection admin may be different from the creator of the collection.|
||Microsoft.Purview/accounts/collection/write||
|purviewmetadatarole\_builtin\_purview-reader|Microsoft.Purview/accounts/data/read|Grants only read access to data handling and all metadata including (classifications, sensitivity labels, insights, read assets in a collection) except scan bindings.|
||Microsoft.Purview/accounts/collection/read||
|purviewmetadatarole\_builtin\_data-curator|Microsoft.Purview/accounts/data/read|Grants full access to data handling and all metadata including (classifications, sensitivity labels, insights, read assets in a collection) except scan bindings.|
||Microsoft.Purview/accounts/data/write||
||Microsoft.Purview/accounts/collection/read||
|purviewmetadatarole\_builtin\_data-share-contributor|Microsoft.Purview/accounts/share/read|Grants access to |
||Microsoft.Purview/accounts/share/write||

{

`  `"values": [

`    `{

`      `"id": "purviewmetadatarole\_builtin\_data-curator",

`      `"name": "data-curator",

`      `"type": "Microsoft.Purview/role",

`      `"properties": {

`        `"provisioningState": "Provisioned",

`        `"roleType": "BuiltIn",

`        `"friendlyName": "Data Curator",

`        `"cnfCondition": [

`          `[

`            `{

`              `"attributeName": "request.azure.dataAction",

`              `"attributeValueIncludedIn": [

`                `"Microsoft.Purview/accounts/data/read",

`                `"Microsoft.Purview/accounts/data/write",

`                `"Microsoft.Purview/accounts/collection/read"

`              `]

`            `}

`          `]

`        `],

`        `"version": 1

`      `}

`    `},

`    `{

`      `"id": "purviewmetadatarole\_builtin\_data-source-administrator",

`      `"name": "data-source-administrator",

`      `"type": "Microsoft.Purview/role",

`      `"properties": {

`        `"provisioningState": "Provisioned",

`        `"roleType": "BuiltIn",

`        `"friendlyName": "Data Source Administrator",

`        `"cnfCondition": [

`          `[

`            `{

`              `"attributeName": "request.azure.dataAction",

`              `"attributeValueIncludedIn": [

`                `"Microsoft.Purview/accounts/scan/read",

`                `"Microsoft.Purview/accounts/scan/write",

`                `"Microsoft.Purview/accounts/collection/read"

`              `]

`            `}

`          `]

`        `],

`        `"version": 1

`      `}

`    `},

`    `{

`      `"id": "purviewmetadatarole\_builtin\_collection-administrator",

`      `"name": "collection-administrator",

`      `"type": "Microsoft.Purview/role",

`      `"properties": {

`        `"provisioningState": "Provisioned",

`        `"roleType": "BuiltIn",

`        `"friendlyName": "Collection Administrator",

`        `"cnfCondition": [

`          `[

`            `{

`              `"attributeName": "request.azure.dataAction",

`              `"attributeValueIncludedIn": [

`                `"Microsoft.Purview/accounts/collection/read",

`                `"Microsoft.Purview/accounts/collection/write"

`              `]

`            `}

`          `]

`        `],

`        `"version": 1

`      `}

`    `},

`    `{

`      `"id": "purviewmetadatarole\_builtin\_purview-reader",

`      `"name": "purview-reader",

`      `"type": "Microsoft.Purview/role",

`      `"properties": {

`        `"provisioningState": "Provisioned",

`        `"roleType": "BuiltIn",

`        `"friendlyName": "Purview Reader",

`        `"cnfCondition": [

`          `[

`            `{

`              `"attributeName": "request.azure.dataAction",

`              `"attributeValueIncludedIn": [

`                `"Microsoft.Purview/accounts/data/read",

`                `"Microsoft.Purview/accounts/collection/read"

`              `]

`            `}

`          `]

`        `],

`        `"version": 1

`      `}

`    `},

`    `{

`      `"id": "purviewmetadatarole\_builtin\_data-share-contributor",

`      `"name": "data-share-contributor",

`      `"type": "Microsoft.Purview/role",

`      `"properties": {

`        `"provisioningState": "Provisioned",

`        `"roleType": "BuiltIn",

`        `"friendlyName": "Data share contributor",

`        `"cnfCondition": [

`          `[

`            `{

`              `"attributeName": "request.azure.dataAction",

`              `"attributeValueIncludedIn": [

`                `"Microsoft.Purview/accounts/share/read",

`                `"Microsoft.Purview/accounts/share/write"

`              `]

`            `}

`          `]

`        `],

`        `"version": 1

`      `}

`    `}

`  `]

}

1. ## API: Get All Metadata Policies
**GET https://{your-purview-account-name}.purview.azure.com/policystore/ metadataPolicies?api-version=2021-07-01**

Lists all the Metadata Policies available across the entire collections hierarchy including and beginning with the Root Collection, as well as all its child policies in tree format.


{

`  `"values": [

`    `{

`      `"name": "policy\_{your-collection-name}",

`      `"id": "c46df4bc-068b-4d45-934d-e31fff12965c",

`      `"version": 26,

`      `"properties": {

`        `"description": "",

`        `"decisionRules": [

`          `{

`            `"kind": "decisionrule",

`            `"effect": "Permit",

`            `"dnfCondition": [

`              `[

`                `{

`                  `"attributeName": "resource.purview.collection",

`                  `"attributeValueIncludes": "{your-collection-name}"

`                `},

`                `{

`                  `"fromRule": "permission:{your-collection-name}",

`                  `"attributeName": "derived.purview.permission",

`                  `"attributeValueIncludes": "permission:{your-collection-name}"

`                `}

`              `]

`            `]

`          `}

`        `],

`        `"attributeRules": [

`          `{

`            `"kind": "attributerule",

`            `"id": "purviewmetadatarole\_builtin\_collection-administrator:{your-collection-name}",

`            `"name": "purviewmetadatarole\_builtin\_collection-administrator:{your-collection-name}",

`            `"dnfCondition": [

`              `[

`                `{

`                  `"attributeName": "principal.microsoft.id",

`                  `"attributeValueIncludedIn": [

`                    `"e245b0d5-24ab-43b2-b1d2-5211ba92807e",

`                    `"2f656762-e440-4b62-9eb6-a991d17d64b0",

`                    `"517a27d2-39ba-4c91-a032-dd9ecf8ad6f1",

`                    `"93a2b357-e009-409f-a08d-6476a0a5b61b"

`                  `]

`                `},

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_collection-administrator",

`                  `"attributeName": "derived.purview.role",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_collection-administrator"

`                `}

`              `]

`            `]

`          `},

`          `{

`            `"kind": "attributerule",

`            `"id": "purviewmetadatarole\_builtin\_purview-reader:{your-collection-name}",

`            `"name": "purviewmetadatarole\_builtin\_purview-reader:{your-collection-name}",

`            `"dnfCondition": [

`              `[

`                `{

`                  `"attributeName": "principal.microsoft.id",

`                  `"attributeValueIncludedIn": [

`                    `"e245b0d5-24ab-43b2-b1d2-5211ba92807e",

`                    `"2f656762-e440-4b62-9eb6-a991d17d64b0",

`                    `"649f56ab-2dd2-40de-a731-3d3f28e7af92",

`                    `"654ab28d-eb5d-42a3-9e66-919beff41196"

`                  `]

`                `},

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_purview-reader",

`                  `"attributeName": "derived.purview.role",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_purview-reader"

`                `}

`              `]

`            `]

`          `},

`          `{

`            `"kind": "attributerule",

`            `"id": "purviewmetadatarole\_builtin\_data-curator:{your-collection-name}",

`            `"name": "purviewmetadatarole\_builtin\_data-curator:{your-collection-name}",

`            `"dnfCondition": [

`              `[

`                `{

`                  `"attributeName": "principal.microsoft.id",

`                  `"attributeValueIncludedIn": [

`                    `"e245b0d5-24ab-43b2-b1d2-5211ba92807e",

`                    `"2f656762-e440-4b62-9eb6-a991d17d64b0",

`                    `"3637973c-8180-4ad3-ab64-d8f75d6b4d26",

`                    `"517a27d2-39ba-4c91-a032-dd9ecf8ad6f1",

`                    `"59b1f657-449b-4cc0-84ad-8f3cdf14e53b"

`                  `]

`                `},

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_data-curator",

`                  `"attributeName": "derived.purview.role",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_data-curator"

`                `}

`              `]

`            `]

`          `},

`          `{

`            `"kind": "attributerule",

`            `"id": "purviewmetadatarole\_builtin\_data-source-administrator:{your-collection-name}",

`            `"name": "purviewmetadatarole\_builtin\_data-source-administrator:{your-collection-name}",

`            `"dnfCondition": [

`              `[

`                `{

`                  `"attributeName": "principal.microsoft.id",

`                  `"attributeValueIncludedIn": [

`                    `"e245b0d5-24ab-43b2-b1d2-5211ba92807e",

`                    `"2f656762-e440-4b62-9eb6-a991d17d64b0",

`                    `"517a27d2-39ba-4c91-a032-dd9ecf8ad6f1",

`                    `"649f56ab-2dd2-40de-a731-3d3f28e7af92",

`                    `"59b1f657-449b-4cc0-84ad-8f3cdf14e53b"

`                  `]

`                `},

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_data-source-administrator",

`                  `"attributeName": "derived.purview.role",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_data-source-administrator"

`                `}

`              `]

`            `]

`          `},

`          `{

`            `"kind": "attributerule",

`            `"id": "permission:{your-collection-name}",

`            `"name": "permission:{your-collection-name}",

`            `"dnfCondition": [

`              `[

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_collection-administrator:{your-collection-name}",

`                  `"attributeName": "derived.purview.permission",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_collection-administrator:{your-collection-name}"

`                `}

`              `],

`              `[

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_purview-reader:{your-collection-name}",

`                  `"attributeName": "derived.purview.permission",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_purview-reader:{your-collection-name}"

`                `}

`              `],

`              `[

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_data-curator:{your-collection-name}",

`                  `"attributeName": "derived.purview.permission",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_data-curator:{your-collection-name}"

`                `}

`              `],

`              `[

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_data-source-administrator:{your-collection-name}",

`                  `"attributeName": "derived.purview.permission",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_data-source-administrator:{your-collection-name}"

`                `}

`              `]

`            `]

`          `}

`        `],

`        `"collection": {

`          `"type": "CollectionReference",

`          `"referenceName": "{your-collection-name}"

`        `}

`      `}

`    `},

`    `{

`      `"name": "policy\_wopmtq",

`      `"id": "86225d83-b728-4e7d-b961-0bb1ffd64703",

`      `"version": 7,

`      `"properties": {

`        `"description": "",

`        `"decisionRules": [

`          `{

`            `"kind": "decisionrule",

`            `"effect": "Permit",

`            `"dnfCondition": [

`              `[

`                `{

`                  `"attributeName": "resource.purview.collection",

`                  `"attributeValueIncludes": "wopmtq"

`                `},

`                `{

`                  `"fromRule": "permission:wopmtq",

`                  `"attributeName": "derived.purview.permission",

`                  `"attributeValueIncludes": "permission:wopmtq"

`                `}

`              `]

`            `]

`          `}

`        `],

`        `"attributeRules": [

`          `{

`            `"kind": "attributerule",

`            `"id": "purviewmetadatarole\_builtin\_collection-administrator:wopmtq",

`            `"name": "purviewmetadatarole\_builtin\_collection-administrator:wopmtq",

`            `"dnfCondition": [

`              `[

`                `{

`                  `"attributeName": "principal.microsoft.id",

`                  `"attributeValueIncludedIn": [

`                    `"e245b0d5-24ab-43b2-b1d2-5211ba92807e",

`                    `"6d8c9613-4dd1-4ac3-95ae-d2bbf89886dc",

`                    `"649f56ab-2dd2-40de-a731-3d3f28e7af92",

`                    `"654ab28d-eb5d-42a3-9e66-919beff41196",

`                    `"59b1f657-449b-4cc0-84ad-8f3cdf14e53b"

`                  `]

`                `},

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_collection-administrator",

`                  `"attributeName": "derived.purview.role",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_collection-administrator"

`                `}

`              `],

`              `[

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_collection-administrator:{your-collection-name}",

`                  `"attributeName": "derived.purview.permission",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_collection-administrator:{your-collection-name}"

`                `}

`              `]

`            `]

`          `},

`          `{

`            `"kind": "attributerule",

`            `"id": "permission:wopmtq",

`            `"name": "permission:wopmtq",

`            `"dnfCondition": [

`              `[

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_collection-administrator:wopmtq",

`                  `"attributeName": "derived.purview.permission",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_collection-administrator:wopmtq"

`                `}

`              `],

`              `[

`                `{

`                  `"fromRule": "permission:{your-collection-name}",

`                  `"attributeName": "derived.purview.permission",

`                  `"attributeValueIncludes": "permission:{your-collection-name}"

`                `}

`              `]

`            `]

`          `}

`        `],

`        `"collection": {

`          `"type": "CollectionReference",

`          `"referenceName": "wopmtq"

`        `},

`        `"parentCollectionName": "{your-collection-name}"

`      `}

`    `},

`    `{

`      `"name": "policy\_ujhlam",

`      `"id": "c35492c3-7b68-4cc2-a8c2-c5cc2d374cef",

`      `"version": 5,

`      `"properties": {

`        `"description": "",

`        `"decisionRules": [

`          `{

`            `"kind": "decisionrule",

`            `"effect": "Permit",

`            `"dnfCondition": [

`              `[

`                `{

`                  `"attributeName": "resource.purview.collection",

`                  `"attributeValueIncludes": "ujhlam"

`                `},

`                `{

`                  `"fromRule": "permission:ujhlam",

`                  `"attributeName": "derived.purview.permission",

`                  `"attributeValueIncludes": "permission:ujhlam"

`                `}

`              `]

`            `]

`          `}

`        `],

`        `"attributeRules": [

`          `{

`            `"kind": "attributerule",

`            `"id": "purviewmetadatarole\_builtin\_collection-administrator:ujhlam",

`            `"name": "purviewmetadatarole\_builtin\_collection-administrator:ujhlam",

`            `"dnfCondition": [

`              `[

`                `{

`                  `"attributeName": "principal.microsoft.id",

`                  `"attributeValueIncludedIn": [

`                    `"e245b0d5-24ab-43b2-b1d2-5211ba92807e",

`                    `"6d8c9613-4dd1-4ac3-95ae-d2bbf89886dc",

`                    `"649f56ab-2dd2-40de-a731-3d3f28e7af92",

`                    `"654ab28d-eb5d-42a3-9e66-919beff41196",

`                    `"59b1f657-449b-4cc0-84ad-8f3cdf14e53b"

`                  `]

`                `},

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_collection-administrator",

`                  `"attributeName": "derived.purview.role",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_collection-administrator"

`                `}

`              `],

`              `[

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_collection-administrator:{your-collection-name}",

`                  `"attributeName": "derived.purview.permission",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_collection-administrator:{your-collection-name}"

`                `}

`              `]

`            `]

`          `},

`          `{

`            `"kind": "attributerule",

`            `"id": "permission:ujhlam",

`            `"name": "permission:ujhlam",

`            `"dnfCondition": [

`              `[

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_collection-administrator:ujhlam",

`                  `"attributeName": "derived.purview.permission",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_collection-administrator:ujhlam"

`                `}

`              `],

`              `[

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_data-curator:ujhlam",

`                  `"attributeName": "derived.purview.permission",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_data-curator:ujhlam"

`                `}

`              `]

`            `]

`          `},

`          `{

`            `"kind": "attributerule",

`            `"id": "purviewmetadatarole\_builtin\_data-curator:ujhlam",

`            `"name": "purviewmetadatarole\_builtin\_data-curator:ujhlam",

`            `"dnfCondition": [

`              `[

`                `{

`                  `"fromRule": "purviewmetadatarole\_builtin\_data-curator",

`                  `"attributeName": "derived.purview.role",

`                  `"attributeValueIncludes": "purviewmetadatarole\_builtin\_data-curator"

`                `},

`                `{

`                  `"attributeName": "principal.microsoft.id",

`                  `"attributeValueIncludedIn": [

`                    `"649f56ab-2dd2-40de-a731-3d3f28e7af92",

`                    `"6d8c9613-4dd1-4ac3-95ae-d2bbf89886dc",

`                    `"517a27d2-39ba-4c91-a032-dd9ecf8ad6f1"

`                  `]

`                `}

`              `]

`            `]

`          `}

`        `],

`        `"collection": {

`          `"type": "CollectionReference",

`          `"referenceName": "ujhlam"

`        `},

`        `"parentCollectionName": "{your-collection-name}"

`      `}

`    `}

`  `]

}

1. ## Get Metadata Policy
At this point you would want to choose the particular policy to modify (add/remove users). To achieve this, shortlist and pick the particular PolicyID from the previous step’s JSON output. PolicyId can be got by either fetching by collectionName or by the policyId. Follow either A or B below.

## 3A. Get MetadataPolicy of the collection by collectionName
**GET https://{your-purview-account-name}.purview.azure.com/policystore/collections/{collectionName}/metadataPolicy?api-version=2021-07-01**

- The Purview account name is {your-purview-account-name}
- You will get the PolicyID back in the “id” field, which is ef212c20-c93a-4614-83ec-d198b91c44d0

{

`  `"name": "policy\_{your-purview-account-name}",

`  `"id": "ef212c20-c93a-4614-83ec-d198b91c44d0",

`  `"version": 9,

`  `"properties": {

`    `"description": "",

`    `"decisionRules": [

`      `{

`        `"kind": "decisionrule",

`        `"effect": "Permit",

`        `"dnfCondition": [

`          `[

`            `{

`              `"attributeName": "resource.purview.collection",

`              `"attributeValueIncludes": "{your-purview-account-name}"

`            `},

`          `]

`        `]

`      `}

`    `],

`    `"collection": {

`      `"type": "CollectionReference",

`      `"referenceName": "{your-purview-account-name}"

`    `}

`  `}

[JSON-truncated-due-to-size]

}

## 3B. Get MetadataPolicy of the collection by policyID
**GET https://{your-purview-account-name}.purview.azure.com/policystore/metadataPolicies/{policyId}?api-version=2021-07-01**

- The Purview account name is {your-purview-account-name}
- You will get the PolicyID back in the “id” field, which is ef212c20-c93a-4614-83ec-d198b91c44d0

{

`  `"name": "policy\_{your-purview-account-name}",

`  `"id": "ef212c20-c93a-4614-83ec-d198b91c44d0",

`  `"version": 9,

`  `"properties": {

`    `"description": "",

`    `"decisionRules": [

`      `{

`        `"kind": "decisionrule",

`        `"effect": "Permit",

`        `"dnfCondition": [

`          `[

`            `{

`              `"attributeName": "resource.purview.collection",

`              `"attributeValueIncludes": "{your-purview-account-name}"

`            `},

`          `]

`        `]

`      `}

`    `],

`    `"collection": {

`      `"type": "CollectionReference",

`      `"referenceName": "{your-purview-account-name}"

`    `}

`  `}

[JSON-truncated-due-to-size]

}


4. ## API: Update Policy: Add / Remove User, Group, Or Service Principal to Collection
**PUT** **https://{your-purview-account-name}.purview.azure.com/policystore/metadataPolicies/{policyId}?api-version=2021-07-01**

Essentially you will update the Policy JSON obtained in previous step and push it to Purview Service using a PUT REST Method.

Whether you wish to **add** or **remove** User/Group/SP (Service Principal), the process is the same using this same API in all the cases.

- You need to pass the AAD ID in an array format in attributeValueIncludedIn array of the JSON.
- Search the JSON output of the Get-Policy-by-ID API in the previous step and **Add** or  **Remove** the service principal object ID, or the user ID or group ID in the attributeValueIncludedIn array. If unsure about how to fetch user or group Object ID, read this tutorial to [search and fetch a user / group / service principal’s Object ID](https://docs.microsoft.com/en-us/powershell/module/azuread/get-azureaduser?view=azureadps-2.0)
- For collection administrator, use the id called purviewmetadatarole\_builtin\_collection-administrator:{your-purview-account-name} 
- If it is the root collection, Replace {your-purview-account-name} with your Purview account name.
- If it is not the root collection, then it will be {collectionName} (same as the 6 character alpha-numeric string returned by Purview).

{

`  `"name": "policy\_{collectionName}",

`  `"id": "c46df4bc-068b-4d45-934d-e31fff12965c",

`  `"version": 17,

`  `"properties": {

`    `"description": "",

`    `"decisionRules": [

`      `{

`        `"kind": "decisionrule",

`        `"effect": "Permit",

`        `"dnfCondition": [

`          `[

`            `{

`              `"attributeName": "resource.purview.collection",

`              `"attributeValueIncludes": "{collectionName}"

`            `},

`            `{

`              `"fromRule": "permission:{collectionName}",

`              `"attributeName": "derived.purview.permission",

`              `"attributeValueIncludes": "permission:{collectionName}"

`            `}

`          `]

`        `]

`      `}

`    `],

`    `"attributeRules": [

`      `{

`        `"kind": "attributerule",

`        `"id": "purviewmetadatarole\_builtin\_collection-administrator:{your-purview-account-name}",

`        `"name": "purviewmetadatarole\_builtin\_collection-administrator:{your-purview-account-name}",

`        `"dnfCondition": [

`          `[

`            `{

`              `"attributeName": "principal.microsoft.id",

`              `"attributeValueIncludedIn": [  // Adding and Removing users from the collection is as easy as adding / removing these GUIDs from this array. These GUIDs are nothing but the Object IDs of the user or group or Service Principal.

`                `"e245b0d5-24ab-43b2-b1d2-5211ba92807e”,

`                `"2f656762-e440-4b62-9eb6-a991d17d64b0",

`                `"517a27d2-39ba-4c91-a032-dd9ecf8ad6f1",

`                `"649f56ab-2dd2-40de-a731-3d3f28e7af92",

`                `"59b1f657-449b-4cc0-84ad-8f3cdf14e53b",

`                `"93a2b357-e009-409f-a08d-6476a0a5b61b",

`                `"6d8c9613-4dd1-4ac3-95ae-d2bbf89886dc",

`                `"2625342c-b82c-48e4-8bc0-a7876345d2ff"

`              `]

`            `},

`            `{

`              `"fromRule": "purviewmetadatarole\_builtin\_collection-administrator",

`              `"attributeName": "derived.purview.role",

`              `"attributeValueIncludes": "purviewmetadatarole\_builtin\_collection-administrator"

`            `}

`          `]

`        `]

`      `},

`      `{

`        `"kind": "attributerule",

`        `"id": "purviewmetadatarole\_builtin\_purview-reader:{your-purview-account-name}",

`        `"name": "purviewmetadatarole\_builtin\_purview-reader:{your-purview-account-name}",

`        `"dnfCondition": [

`          `[

`            `{

`              `"attributeName": "principal.microsoft.id",

`              `"attributeValueIncludedIn": [

`                `"e245b0d5-24ab-43b2-b1d2-5211ba92807e",

`                `"2f656762-e440-4b62-9eb6-a991d17d64b0",

`                `"649f56ab-2dd2-40de-a731-3d3f28e7af92"

`              `]

`            `},

`            `{

`              `"fromRule": "purviewmetadatarole\_builtin\_purview-reader",

`              `"attributeName": "derived.purview.role",

`              `"attributeValueIncludes": "purviewmetadatarole\_builtin\_purview-reader"

`            `}

`          `]

`        `]

`      `},

`      `{

`        `"kind": "attributerule",

`        `"id": "purviewmetadatarole\_builtin\_data-curator:{your-purview-account-name}",

`        `"name": "purviewmetadatarole\_builtin\_data-curator:{your-purview-account-name}",

`        `"dnfCondition": [

`          `[

`            `{

`              `"attributeName": "principal.microsoft.id",

`              `"attributeValueIncludedIn": [

`                `"e245b0d5-24ab-43b2-b1d2-5211ba92807e",

`                `"2f656762-e440-4b62-9eb6-a991d17d64b0",

`                `"3637973c-8180-4ad3-ab64-d8f75d6b4d26",

`                `"517a27d2-39ba-4c91-a032-dd9ecf8ad6f1",

`                `"649f56ab-2dd2-40de-a731-3d3f28e7af92",

`                `"59b1f657-449b-4cc0-84ad-8f3cdf14e53b"

`              `]

`            `},

`            `{

`              `"fromRule": "purviewmetadatarole\_builtin\_data-curator",

`              `"attributeName": "derived.purview.role",

`              `"attributeValueIncludes": "purviewmetadatarole\_builtin\_data-curator"

`            `}

`          `]

`        `]

`      `},

`      `{

`        `"kind": "attributerule",

`        `"id": "purviewmetadatarole\_builtin\_data-source-administrator:{your-purview-account-name}",

`        `"name": "purviewmetadatarole\_builtin\_data-source-administrator:{your-purview-account-name}",

`        `"dnfCondition": [

`          `[

`            `{

`              `"attributeName": "principal.microsoft.id",

`              `"attributeValueIncludedIn": [

`                `"e245b0d5-24ab-43b2-b1d2-5211ba92807e",

`                `"2f656762-e440-4b62-9eb6-a991d17d64b0",

`                `"517a27d2-39ba-4c91-a032-dd9ecf8ad6f1",

`                `"649f56ab-2dd2-40de-a731-3d3f28e7af92",

`                `"59b1f657-449b-4cc0-84ad-8f3cdf14e53b"

`              `]

`            `},

`            `{

`              `"fromRule": "purviewmetadatarole\_builtin\_data-source-administrator",

`              `"attributeName": "derived.purview.role",

`              `"attributeValueIncludes": "purviewmetadatarole\_builtin\_data-source-administrator"

`            `}

`          `]

`        `]

`      `},

`      `{

`        `"kind": "attributerule",

`        `"id": "permission:{your-purview-account-name}",

`        `"name": "permission:{collectionName}",

`        `"dnfCondition": [

`          `[

`            `{

`              `"fromRule": "purviewmetadatarole\_builtin\_collection-administrator:{collectionName}",

`              `"attributeName": "derived.purview.permission",

`              `"attributeValueIncludes": "purviewmetadatarole\_builtin\_collection-administrator:{collectionName}"

`            `}

`          `],

`          `[

`            `{

`              `"fromRule": "purviewmetadatarole\_builtin\_purview-reader:{collectionName}",

`              `"attributeName": "derived.purview.permission",

`              `"attributeValueIncludes": "purviewmetadatarole\_builtin\_purview-reader:{collectionName}"

`            `}

`          `],

`          `[

`            `{

`              `"fromRule": "purviewmetadatarole\_builtin\_data-curator:{collectionName}",

`              `"attributeName": "derived.purview.permission",

`              `"attributeValueIncludes": "purviewmetadatarole\_builtin\_data-curator:{collectionName}"

`            `}

`          `],

`          `[

`            `{

`              `"fromRule": "purviewmetadatarole\_builtin\_data-source-administrator:{collectionName}",

`              `"attributeName": "derived.purview.permission",

`              `"attributeValueIncludes": "purviewmetadatarole\_builtin\_data-source-administrator:{collectionName}"

`            `}

`          `]

`        `]

`      `}

`    `],

`    `"collection": {

`      `"type": "CollectionReference",

`      `"referenceName": "{collectionName}"

`    `}

`  `}

}

4. ## How to add root collection admin using management API
In some cases, an organization needs to add a different root collection admin using the API instead of the Purview Studio. It is possible that the current root collection admin doesn’t exist in the organization anymore. 

**POST https://management.azure.com/subscriptions/:subscriptionId/resourceGroups/{resourceGroupName}/providers/Microsoft.Purview/accounts/{accountName}/addRootCollectionAdmin?api-version=2021-07-01**

You only need to pass in the objectId for the user or group

{

`    `"objectId": "93a2b357-e009-409f-a08d-6476a0a5b61b"

}

If success, you will get response 200.

If you don’t have permission, you will get below error:

{

`    `"error": {

`        `"code": "19000",

`        `"message": "The caller does not have Microsoft.Authorization/roleAssignments/write permission on resource: [/subscriptions/aa41bbd9-a6aa-44a8-b5cb-b05f7d4fa592/resourceGroups/UX-Design-Group].",

`        `"target": **null**,

`        `"details": []

`    `}

}

Note: The user who calls this API must have owner or UAA permission on Purview account to execute a write action on the account.




# MetadataPolicy & MetadataRoles API Reference

Link to API Reference (TBD updated when this tutorial goes on github)

Add Swagger.zip as attachment. (TBD updated when this tutorial goes on github)
