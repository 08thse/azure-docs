---
title: Troubleshooting common Az CLI Azure Operator Service Manager (AOSM) Extension Issues
description: Learn how to resolve common issues and misconfigurations when using the Az CLI AOSM extension.
author: pjw711
ms.author: peterwhiting
ms.service: azure-operator-service-manager
ms.topic: troubleshooting
ms.date: 03/19/2024
ms.custom: troubleshooting
---

# Common Azure CLI Azure Operator Service Manager (AOSM) extension issues

This document contains a list of common issues when using the Azure CLI AOSM extension to onboard Network Functions, and their resolutions.

## Common issues

### NSD artifact upload failure

Artifact uploads using `az aosm nsd publish` command can fail on rare occasions. The error output in this case is

```azurecli
ValueError: Issue retrieving session url: {'errors': [{'code': 'UNAUTHORIZED', 'message': 'authentication required, visit https://aka.ms/acr/authorization for more information.', 'detail': [{'Type': 'repository', 'Name': 'contoso-nsd', 'Action': 'pull'}, {'Type': 'repository', 'Name': 'contoso-nsd', 'Action': 'push'}]}]}
```

To resolve this error:

**Option 1.**
Confirm that you have the `Contributor` and `AcrPush` role assignments on the subscription that will contain the AOSM-managed Artifact Store. Assign them if you don't. If this is not possible, run the `az aosm nsd publish` command with the `--no-subscription-permissions` parameter.

**Option 2.**
If this doesn't resolve the issue, run the following commands from the `nsd-cli-output/artifacts` folder created by the `az aosm nsd build` command:

- Build the Network Function ARM Template from the BICEP file generated by the CLI

```azurecli
bicep build <nf-name>.bicep
```

- Generate scope map token credentials from the Artifact Manifest created in the `az aosm nsd publish` command.

> [!IMPORTANT]
> You are required to use the Artifact Manifest created in the `az aosm nsd publish` command. The NF ARM template is only declared in that manifest hence only the scope map token generated by this manifest will allow you to push (or pull) the NF ARM template to the Artifact Store.

```azurecli
az rest --method POST --url 'https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<resource-group>/providers/Microsoft.HybridNetwork/publishers/<publisher>/artifactStores/<artifact-store>/artifactManifests/<artifactManifest>/listCredential?api-version=2023-09-01'
```

- [Install ORAS](https://oras.land/docs/installation/) and log in to the AOSM managed ACR. The AOSM managed ACR name can be found in Azure Portal blade for the Artifact Store resource. The username and password can be found in the output of the previous step.

```bash
oras login <aosm-managed-acr-name>.azurecr.io --username <username> --password <scope map token>
```

- Use ORAS to upload the Network Function ARM template to the AOSM managed Azure Container Registry (ACR). The `<arm-template-version>` artifact tag must be in `1.0.0` format.

```bash
oras push <aosm-managed-acr-name>.azurecr.io/Contoso-nsd:<arm-template-version> ./nsd-cli-output/artifacts/<nf-name>.json
```

### Cross-tenant copy failures

The Azure CLI AOSM Extension does not natively support cross-tenant image copies. However, it is possible to configure your CLI environment in a way that allows this functionality. The process is to set the default Azure subscription to the subscription that contains the source ACR, log in to the source ACR, and then run all `az aosm` commands with the `--subscription` parameter, setting the value to the target subscription. The source and target subscriptions can be in different tenants.

```azurecli
az account set --subscription <source-acr-subscription>
az acr login --name <source-acr-name> -u <source-acr-username> -p <source-acr-password> --subscription <source-acr-subscription>
az aosm nfd publish --definition-type cnf --subscription <target-subscription>
```

## Common misconfigurations

### SNS deployment fails when Site resource NFVI and NFVIsFromSite in NSDV do not match

SNS creation attempts will fail if the nfvi property of the Site resource does not match the nfvisFromSite property of the NSDV. The error is

```json
{
"statusMessage": "{\"status\":\"Failed\",\"error\":{\"code\":\"ResourceOperationFailure\",\"message\":\"The resource operation completed with terminal provisioning state 'Failed'.\",\"details\":[{\"code\":\"InvalidRequestContent\",\"message\":\"For NfviAlias = nfvi1, either NfviName = nsd-contoso_NFVI and NfviType = AzureCore does not match with site resource.\"}]}}",
}

```

In this example, the NSDV nfvisFromSite property contains

```json
    nfvisFromSite: {
      nfvi1: {
        name: 'nsd-contoso_NFVI'
        type: 'AzureArcKubernetes'
      }
```

The Site resource nfvi propery must match the name and type in the NSDV.

```bicep
resource site 'Microsoft.HybridNetwork/sites@2023-09-01' = {
  name: 'contoso-site'
  location: 'eastus'
  properties: {
    nfvis : [
      {
        name: 'nsd-contoso_NFVI'
        nfviType: 'AzureArcKubernetes'
        customLocationReference: {
          id: '<custom-location-arm-id>'
        }
      }
    ]
  }
}
```

### nfdvName in CGV does not match the published NFDV name

Configuration group schemas generated by the Azure CLI AOSM Extension have a mandatory parameter called `nfdvName`. This is the name of the NDFV, which is a string in `1.0.0` format. It is not the name of the NF or NFDG. The following example shows the correct usage.

```json
{
    "nsd-contoso": {
        "nfdvName": "1.0.0",
        "deploymentParameters": [
            {}
        ],
        "customLocationId": "<custom-location-arm-id>",
        "managedIdentityId": "<managed-id-arm-id>"
    }
}
```

### Incorrect CGV values property when exposing no parameters in a Configuration Group Schema (CGS)

Configuration group schemas generated by the Azure CLI AOSM Extension exposes a `deploymentParameters` field which, by default, is an array of JSON objects. There are several reasons you may want to create a CGV with an empty `deploymentParameters` field:

- You have no configuration exposed in the Configuration Group Schema and all values are set in the default values.yaml in the Helm chart.
- You have created a Configuration group schema which includes default values and you do not want to override them.

If you are creating a CGV with an empty `deploymentParameters` field, the field value must be an array containing an empty JSON object.

```json
{
    "nsd-contoso": {
        "nfdvName": "1.0.0",
        "deploymentParameters": [
            {}
        ],
        "customLocationId": "<custom-location-arm-id>",
        "managedIdentityId": "<managed-id-arm-id>"
    }
}
```

AOSM will return the following error message if the CGV contains an empty array (ie, `[]`) instead of an array containing an empty object (`[{}]`)

```json
{"code":"BadRequest","message":"NSDV ResourceElementTemplate (name: 'mco-nsdg', type: 'NetworkFunctionDefinition') expects at least one 'networkfunctions' resource in the associated template. Please use the type: 'ArmResourceDefinition' to install generic ARM resources."}
```

### Cyclic dependsOnProfile errors

AOSM will raise an error if you attempt to deploy a network function (NF) which references an NFDV with cyclic network function application dependencies. Here's an example error:

```json
 {
  "id": "/providers/Microsoft.HybridNetwork/locations/EASTUS2EUAP/operationStatuses/<operation-id>",
  "name": "<operation-id>",
  "resourceId": "/subscriptions/<subscription>/resourceGroups/<resource-group>/providers/Microsoft.HybridNetwork/networkfunctions/<nf-name>",
  "status": "Failed",
  "startTime": "2023-07-17T20:48:01.4792943Z",
  "endTime": "2023-07-17T20:48:10.0191285Z",
  "error": {
    "code": "DependenciesValidationFailed",
    "message": "CyclicDependencies: Circular dependencies detected at <nf-application-name>."
  }
}
```

The error message includes the NF application which contains the cyclic dependency. The solution is to resolve the dependency, either by editing the Azure CLI AOSM extension input file and rerunning the `nfd build` and `nfd publish` commands. You can also edit the `dependsOnProfile` property of the affected NF applications in the NFDV manually.
