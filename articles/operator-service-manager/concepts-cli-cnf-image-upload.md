---
title: Learn how the Azure Operator Service Manager (AOSM) CLI extension discovers container images in source ACRs based on helm chart configuration
description: Learn how the Azure Operator Service Manager (AOSM) CLI extension discovers container images in source ACRs based on helm chart configuration
author: pjw711
ms.author: peterwhiting
ms.date: 04/12/2024
ms.topic: concept-article
ms.service: azure-operator-service-manager
ms.custom: devx-track-azurecli

---
# Learn how the Azure Operator Service Manager (AOSM) CLI extension discovers container images in source ACRs based on helm chart configuration

This document explains how the Azure CLI AOSM extension discovers images in helm charts and pulls them from an Azure Container Registry (ACR) or alternative container registry and uploads them to an AOSM Artifact Store.

## Image Discovery

The Azure CLI AOSM extension NFDV input file, generated by `az aosm nfd generate-config --definition-type cnf`, contains one parameter that specifies the source registries (and optionally repositories) the AOSM CLI will query during container image onboarding.

```jsonc
  // List of registries from which to pull the image(s).
  // For example [sourceacr.azurecr.io/test, myacr2.azurecr.io, ghcr.io/path].
  // For non Azure Container Registries, ensure you have run a docker login command before running build.
  "image_sources": [],
```

`"image_sources"` is an array of strings. Each string is a reference to a container registry and, optionally, an additional repository path.

The Az CLI AOSM extension:

- Parses the Kubernetes definition files generated by `helm template` to discover the container image references.
- Searches in the registries and repository paths included in the "image_sources" array for the container image references.
- Copies the images from the source registries to the AOSM artifact store.

>[!IMPORTANT]
>The AOSM CLI requires that the images in your source registry are in the same repository structure as is written in your helm chart. For example, an image included in a helm chart as `core/contoso-a:1.0.0` must be available in the source registry in a path that ends in `core/contoso-a:1.0.0`. Any additional repository prefix must be included in the `"image_sources"` parameter in the `cnf-input.json` file generated by the `az aosm nfd generate-config --definition-type cnf` command.

## Worked example

This example describes a fictional CNF. This CNF is built of three images that provide the core CNF function and one test image that can be deployed to execute test queries against the CNF. The source registry for the images is an ACR called `myregistry`. In this example we onboard all four images.

The "image_sources" field in the NDFV input file is set as follows

```jsonc
  // List of registries from which to pull the image(s).
  // For example [sourceacr.azurecr.io/test, myacr2.azurecr.io, ghcr.io/path].
  // For non Azure Container Registries, ensure you have run a docker login command before running build.
  "image_sources": ["myregistry.azurecr.io"],
```

The output of `helm template` against the helm charts for this CNF gives four image lines in the Kubernetes deployment definition.

```yaml
image: release/contoso-a:1.0.0
image: release/contoso-b:1.0.0
image: release/contoso-c:1.0.0
image: test-release/contoso-test:1.0.0
```

The Azure CLI AOSM extension searches for the images in `myregistry.azurecr.io/release/contoso-a:1.0.0`, `myregistry.azurecr.io/release/contoso-b:1.0.0`, `myregistry.azurecr.io/release/contoso-c:1.0.0`, and `myregistry.azurecr.io/test-release/contoso-test:1.0.0` when `az aosm nfd publish` is run. The images must be available in these paths.

### Namespacing

The Azure CLI AOSM extension also supports image namespacing in source container registries. For example, the `contoso-test` image could have been uploaded to `test/test-release/contoso-test:1.0.0` in the source registry. In this case, the additional repository, `test`, must be configured in the `"image_sources"` parameter in the NFDV input file.

```jsonc
  // List of registries from which to pull the image(s).
  // For example [sourceacr.azurecr.io/test, myacr2.azurecr.io, ghcr.io/path].
  // For non Azure Container Registries, ensure you have run a docker login command before running build.
  "image_sources": ["myregistry.azurecr.io", "myregistry.azurecr.io/test"],
```

When `az aosm nfd publish` is run, the Azure AOSM CLI extension will search for the images in `myregistry.azurecr.io`, where it will discover `contoso-a`, `contoso-b`, and `contoso-c`. It will then search in `myregistry.azurecr.io/test`, where it will discover `contoso-test`.

## Next steps

- [How to onboard a CNF using the CLI](how-to-onboard-a-cnf-using-the-azure-cli.md)