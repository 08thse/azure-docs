---
title: Device Update for IoT Hub update manifest | Microsoft Docs
description: Learn how properties are sent from the Device Update service to the device during an update
author: andbrown
ms.author: andbrown
ms.date: 2/17/2021
ms.topic: conceptual
ms.service: iot-hub-device-update
---


# Device Update for IoT Hub update manifest

## Overview

Device Update for IoT Hub uses an _update manifest_ to communicate actions and also metadata supporting those actions through the
 [AzureDeviceUpdateCore.OrchestratorMetadata:4](./device-update-plug-and-play.md)interface properties.
 This document describes the fundamentals of how the `updateManifest` property, in the
 `AzureDeviceUpdateCore.OrchestratorMetadata:4` interface, is used by the Device Update Agent. The
 `AzureDeviceUpdateCore.OrchestratorMetadata:4` interface properties are sent from the Device Update for IoT Hub service
 to the Device Update Agent. The `updateManifest` is a serialized JSON Object that is parsed by the Device Update Agent.

### An example update manifest

```JSON
{
    "manifestVersion": "1",
    "updateId": {
        "provider": "DuTest",
        "name": "DuTestUser",
        "version": "2020.611.534.16"
    },
    "updateType": "microsoft/swupdate:1",
    "installedCriteria": "1.0",
    "files": {
        "00000": {
            "fileName": "image.swu",
            "sizeInBytes": 256000,
            "hashes": {
                "sha256": "IhIIxBJpLfazQOk/PVi6SzR7BM0jf4HDqw+6gdZ3vp8="
            }
        }
    },
    "createdDateTime": "2020-06-12T00:38:13.9350278"
}
```

The purpose of the update manifest is to describe the contents of an update, namely its identity, type,
installed criteria, and update file metadata. In addition, the update manifest is cryptographically signed to
allow the Device Update Agent to verify its authenticity.

### Securing update content via the update manifest

The update manifest is validated by using two signatures. The signatures are created using a structure consisting of *signing* keys and *root* keys.

The Device Update Agent has embedded public keys that are used for all Device Update-compatible devices. These are the *root* keys. The corresponding private keys are controlled by Microsoft.

Microsoft also generates a public/private key pair that is not included in the Device Update Agent or stored on the device. This is the *signing* key.

When an update is imported into Device Update for IoT Hub, and the update manifest is generated by the service, the service signs the manifest using the signing key, and includes the signing key itself, which is signed by a root key. When the update manifest is sent to the device, the Device Update Agent receives the following signature data:

1. The signature value itself.
2. The algorithm used for generating #1.
3. The public key information of the signing key used for generating #1.
4. The signature of the public signing key in #3.
5. The public key ID of the root key used for generating #3.
6. The algorithm used for generating #4.

The Device Update Agent uses the information defined above to validate that signature of the public signing key is signed by the root key. The Device Update Agent then validates that the update manifest signature is signed by the signing key. If all the signatures are correct, the update manifest is trusted by the Device Update Agent. Since the update manifest includes the file hashes that correspond to the update files themselves, the update files can then also be trusted if the hashes match.

Having root and signing keys allows Microsoft to periodically roll the signing key, a security best practice.

### JSON Web Signature (JWS)

The `updateManifestSignature` is used to ensure that the information contained within the `updateManifest` has
not been tampered with. The `updateManifestSignature` is produced using a JSON Web Signature with JSON Web Keys, allowing for source verification. The signature is a Base64Url Encoded string with three sections delineated by ".".  Refer to the jws_util.h helper methods for parsing and verifying JSON keys and tokens.

JSON Web Signature is a widely used [proposed IETF standard](https://tools.ietf.org/html/rfc7515) for signing
content using JSON-based data structures. It is a way of ensuring integrity of data by verifying the signature
of the data. Further information can be found in the JSON Web Signature (JWS) [RFC 7515](https://www.rfc-editor.org/info/rfc7515).

### JSON Web Token

JSON Web Tokens are an open, industry [standard](https://tools.ietf.org/html/rfc7519) method for representing
claims securely between two parties.

## Import manifest vs update manifest

It is important to understand the differences between the import manifest and the update manifest concepts in Device Update for IoT Hub. 
* The [import manifest](./import-concepts.md) is created by whoever creates the corresponding update. It describe the contents of the update that will be imported into Device Update for IoT Hub. 
* The update manifest is automatically generated by the Device Update for IoT Hub service, using some of the properties that were defined in the import manifest. It is used to communicate relevant information to the Device Update Agent during the update process. 

Each manifest type has its own schema and schema version.

## Update manifest properties

The high-level definitions of the update manifest properties can be found in the interface definitions found
[here](./device-update-plug-and-play.md). To provide deeper context, let's take a closer look
at the properties and how they are used in the system.

### updateId

Contains the `provider`, `name`, and `version`, which represents the exact Device Update for IoT Hub update identity used
to determine compatible devices for the update.

### updateType

Represents the type of update which is handled by a specific type of update handler. It follows the form
of `microsoft/swupdate:1` for an image-based update and `microsoft/apt:1` for a package-based update (see `Update Handler Types` section below).

### installedCriteria

A string that contains information needed by Device Update Agent's Update Handler to determine whether the update is
installed on the device. The `Update Handler Types` section documents the format of the `installedCriteria`,
for each update type supported by Device Update for IoT Hub.

### files

Tells the Device Update Agent which files to download, and the hash that will be used to use to verify the files were downloaded correctly.
Here's a closer look at the `files` property contents:

```json
"files":{
        <FILE_ID_STRING>:{
            "fileName":<STRING>,
            "sizeInBytes":<INTEGER>,
            "hashes":{
                <HASH-TYPE>:<HASH-STRING>
            }
        }
    }
```

Outside of the `updateManifest` is the `fileUrls` array of JSON Object.

```json
"fileUrls":{
      <FILE_ID_STRING>: <URL-in-String-Format>
 }
```

Both the `FILE_ID_STRING`, within `fileUrls`, and `files` are the same (for example, "0000" in `files` has the url
at "0000" within `fileUrls`).

### manifestVersion

A string that represents the schema version.

## Update Handler Types

|Update Method|Update Handler Type|Update Type|Installed Criteria|Expected Files for Publishing|
|-------------|-------------------|----------|-----------------|--------------|
|Image-based|SWUpdate|"microsoft/swupdate:version"|The reference image saves the hint of its version in the /etc/adu-version file.  |.swu file that contains SWUpdate image|
|Package-based|APT|"microsoft/apt:version"|`<name>` + "-" + `<version>` (defined properties in the APT Manifest file|`<APT Update Manifest>`.json that contains the APT configuration and package list|

