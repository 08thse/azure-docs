---
title: "Tutorial: Use code interpreter sessions in LangChain with Azure Container Apps"
description: Learn to use code interpreter sessions in LangChain on Azure Container Apps.
services: container-apps
author: craigshoemaker
ms.service: container-apps
ms.topic: tutorial
ms.date: 04/04/2024
ms.author: cshoe
---

# Tutorial: Use code interpreter sessions in LangChain with Azure Container Apps

LangChain is a framework designed to simplify the creation of applications using large language models (LLMs). When you build an agent with LangChain, an LLM interprets user input and generates a response. The AI agent often struggles when it needs to perform mathematical and symbolic reasoning to produce a response. By integrating [Azure Container Apps sessions](sessions.md) with LangChain, you give the agent a [code interpreter](sessions-code-interpreter.md) to use to perform specialized tasks.

In this tutorial, you learn how to run a LangChain AI agent in a web API app. The API accepts user input and returns a response generated by the AI agent. The agent uses a code interpreter in dynamic sessions to perform calculations.

> [!NOTE]
> Azure Container Apps dynamic sessions is currently in preview.

## Prerequisites

- An Azure account with an active subscription.
  - If you don't have one, you [can create one for free](https://azure.microsoft.com/free/).
- Install the [Azure CLI](/cli/azure/install-azure-cli).
- Git.
- Python 3.8 or later.

## Create Azure resources

The sample app in this quickstart uses an LLM from Azure OpenAI. It also uses Azure Container Apps sessions to run code generated by the LLM.

1. Update the Azure CLI to the latest version.

   ```bash
    az upgrade
    ```

1. Remove the Azure Container Apps extension if it's already installed and install a preview version the Azure Container Apps extension containing commands for sessions:

    ```bash
    az extension remove --name containerapp
    az extension add \
        --source https://stacyzengstorageacct.blob.core.windows.net/sessioncli/containerapp-0.3.50-py2.py3-none-any.whl \
        --allow-preview true -y
    ```

1. Sign in to Azure:

   ```bash
   az login
   ```

1. Set the variables used in this quickstart:

    ```bash
    RESOURCE_GROUP_NAME=aca-sessions-tutorial
    AZURE_OPENAI_LOCATION=swedencentral
    AZURE_OPENAI_NAME=<UNIQUE_OPEN_AI_NAME>
    SESSION_POOL_LOCATION=eastasia
    SESSION_POOL_NAME=code-interpreter-pool
    ```

    Replace `<UNIQUE_OPEN_AI_NAME>` with a unique name to create your Azure OpenAI account.

1. Create a resource group:

   ```bash
   az group create --name $RESOURCE_GROUP_NAME --location $SESSION_POOL_LOCATION
   ```

1. Create an Azure OpenAI account:

    ```bash
    az cognitiveservices account create \
        --name $AZURE_OPENAI_NAME \
        --resource-group $RESOURCE_GROUP_NAME \
        --location $AZURE_OPENAI_LOCATION \
        --kind OpenAI \
        --sku s0 \
        --custom-domain $AZURE_OPENAI_NAME
    ```

1. Create a GPT 3.5 Turbo model deployment named `gpt-35-turbo` in the Azure OpenAI account:

    ```bash
    az cognitiveservices account deployment create \
        --resource-group $RESOURCE_GROUP_NAME \
        --name $AZURE_OPENAI_NAME \
        --deployment-name gpt-35-turbo \
        --model-name gpt-35-turbo \
        --model-version "1106" \
        --model-format OpenAI \
        --sku-capacity "100" \
        --sku-name "Standard"
    ```

1. Create a code interpreter session pool:

    ```bash
    az containerapp sessionpool create \
        --name $SESSION_POOL_NAME \
        --resource-group $RESOURCE_GROUP_NAME \
        --location $SESSION_POOL_LOCATION \
        --max-concurrent-sessions 100 \
        --container-type PythonLTS \
        --cooldown-period 300
    ```

## Configure the sample app locally

1. Clone the [Azure Container Apps sessions samples repository](https://github.com/Azure-Samples/container-apps-dynamic-sessions-samples).

    ```bash
    git clone https://github.com/Azure-Samples/container-apps-dynamic-sessions-samples.git
    ```

1. Change to the directory that contains the sample app:

    ```bash
    cd container-apps-dynamic-sessions-samples/langchain-python-webapi
    ```

1. Create a Python virtual environment and activate it:

    ```bash
    python3.11 -m venv .venv
    source .venv/bin/activate
    ```

    Change the Python version in the command if you're using a different version. It's recommended to use Python 3.8 or later.

    > [!NOTE]
    > If you're using Windows, replace `.venv/bin/activate` with `.venv\Scripts\activate`.

1. Install the required Python packages:

    ```bash
    python -m pip install -r requirements.txt
    ```

1. To run the app, you need to configure environment variables.

    1. Retrieve the Azure OpenAI account endpoint:

        ```bash
        az cognitiveservices account show \
            --name $AZURE_OPENAI_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --query properties.endpoint \
            --output tsv
        ```

    1. Retrieve the Azure Container Apps session pool management endpoint:

        ```bash
        az containerapp sessionpool show \
            --name $SESSION_POOL_NAME \
            --resource-group $RESOURCE_GROUP_NAME \
            --query properties.poolManagementEndpoint \
            --output tsv
        ```

    1. Create a `.env` file in the root of the sample app directory (`langchain-python-webapi`). Add the following content to the file:

        ```text
        AZURE_OPENAI_ENDPOINT=<AZURE_OPENAI_ENDPOINT>
        POOL_MANAGEMENT_ENDPOINT=<SESSION_POOL_MANAGEMENT_ENDPOINT>
        ```

        Replace `<AZURE_OPENAI_ENDPOINT>` with the Azure OpenAI account endpoint and `<SESSION_POOL_MANAGEMENT_ENDPOINT>` with the session pool management endpoint.

1. The app uses `DefaultAzureCredential` to authenticate with Azure services. On your local machine, it uses your current Azure CLI login credentials. You must give yourself the *Cognitive Services OpenAI User* role on the Azure OpenAI account for the app to access the model endpoints.

    1. Run the following commands to retrieve the Azure OpenAI account resource ID:

        ```bash
        az cognitiveservices account show --name $AZURE_OPENAI_NAME --resource-group $RESOURCE_GROUP_NAME --query id --output tsv
        ```

    1. Retrieve your Azure CLI user name:

        ```bash
        az account show --query user.name --output tsv
        ```

    1. Assign the *Cognitive Services OpenAI User* role to your Azure CLI user on the Azure OpenAI account:

        ```bash
        az role assignment create --role "Cognitive Services OpenAI User" --assignee <CLI_USERNAME> --scope <AZURE_OPENAI_RESOURCE_ID>
        ```

    Replace `<CLI_USERNAME>` with your Azure CLI user name and `<AZURE_OPENAI_RESOURCE_ID>` with the Azure OpenAI account resource ID.


## Run the sample app locally

Before running the sample app, open *main.py* in an editor and review the code. The app uses FastAPI to create a web API that accepts a user message in the query string.

The following lines of code instantiates a *SessionPythonREPLTool* and provides it to the LangChain agent:

```python
repl = SessionsPythonREPLTool(
    pool_management_endpoint=pool_management_endpoint,
)

tools = [repl]
react_agent = agents.create_react_agent(
    llm=llm,
    tools=tools,
    prompt=hub.pull("hwchase17/react"),
)
```

When it needs to perform calculations, the agent uses the *SessionPythonREPLTool* to run the code. The code is executed in a session in the session pool. By default, a random session identifier is generated when you instantiate the tool. If the agent runs multiple Python code snippets, it uses the same session.

*SessionPythonREPLTool* is available in the `langchain-azure-dynamic-sessions` package.

1. Run the sample app:

    ```bash
    fastapi dev main.py
    ```

1. Open a browser and navigate to `http://localhost:8000/docs`. You see the Swagger UI for the sample app.

1. Expand the `/chat` endpoint and select **Try it out**.

1. Enter `What time is it right now?` in the `message` field and select **Execute**.

    The agent responds with the current time. In the terminal, you see the logs showing the agent generated Python code to get the current time and ran it in a code interpreter session using the *SessionPythonREPLTool*.

## Optional: Deploy the sample app to Azure Container Apps

To deploy the FastAPI app to Azure Container Apps, you need to create a container image and push it to a container registry. Then you can deploy the image to Azure Container Apps. The `az containerapp up` command combines these steps into a single command.

You then need to configure managed identity for the app and assign it the proper roles to access Azure OpenAI and the session pool.

1. Set the variables for the Container Apps environment and app name:

    ```bash
    ENVIRONMENT_NAME=aca-sessions-tutorial-env
    CONTAINER_APP_NAME=chat-api
    ```

1. Build and deploy the app to Azure Container Apps:

    ```bash
    az containerapp up \
        --name $CONTAINER_APP_NAME \
        --resource-group $RESOURCE_GROUP_NAME \
        --location $SESSION_POOL_LOCATION \
        --environment $ENVIRONMENT_NAME \
        --env-vars "AZURE_OPENAI_ENDPOINT=<OPEN_AI_ENDPOINT>" "POOL_MANAGEMENT_ENDPOINT=<SESSION_POOL_MANAGMENT_ENDPOINT>" \
        --source .
    ```

    Replace `<OPEN_AI_ENDPOINT>` with the Azure OpenAI account endpoint and `<SESSION_POOL_MANAGMENT_ENDPOINT>` with the session pool management endpoint.

1. Enable the system-assigned managed identity for the app:

    ```bash
    az containerapp identity assign \
        --name $CONTAINER_APP_NAME \
        --resource-group $RESOURCE_GROUP_NAME \
        --system-assigned
    ```

1. Get the managed identity's principal ID and fully qualified domain name (FQDN):

    ```bash
    az containerapp show \
        --name $CONTAINER_APP_NAME \
        --resource-group $RESOURCE_GROUP_NAME \
        --query "{principalId:identity.principalId, fqdn:properties.configuration.ingress.fqdn}" \
        --output json
    ```

1. Get the session pool resource ID:

    ```bash
    az containerapp sessionpool show \
        --name $SESSION_POOL_NAME \
        --resource-group $RESOURCE_GROUP_NAME \
        --query id \
        --output tsv
    ```

1. Assign the managed identity the `Azure ContainerApps Session Creator` role on the session pool:

    Before you run the following command, replace `<PRINCIPAL_ID>` and `<SESSION_POOL_RESOURCE_ID>` with the values you retrieved in the previous steps.

    ```bash
    az role assignment create \
        --role "Azure ContainerApps Session Creator" \
        --assignee <PRINCIPAL_ID> \
        --scope <SESSION_POOL_RESOURCE_ID>
    ```

1. Get the Azure OpenAI account resource ID:

    ```bash
    az cognitiveservices account show \
        --name $AZURE_OPENAI_NAME \
        --resource-group $RESOURCE_GROUP_NAME \
        --query id \
        --output tsv
    ```

1. Assign the managed identity the `Cognitive Services OpenAI User` role on the Azure OpenAI account:

    Before you run the following command, replace `<PRINCIPAL_ID>` and `<AZURE_OPENAI_RESOURCE_ID>` with the values you retrieved in the previous steps.

    ```bash
    az role assignment create \
        --role "Cognitive Services OpenAI User" \
        --assignee <PRINCIPAL_ID> \
        --scope <AZURE_OPENAI_RESOURCE_ID>
    ```

1. Open the browser to `https://<fqdn>/docs` to test the deployed app.

## Clean up resources

When you're done with the resources, you can delete them to avoid incurring charges:

```bash
az group delete --name $RESOURCE_GROUP_NAME --yes --no-wait
```

## Next steps

> [!div class="nextstepaction"]
> [Code interpreter sessions](./sessions-code-interpreter.md)
