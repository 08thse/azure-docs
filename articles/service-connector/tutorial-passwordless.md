---
title: 'Tutorial: Create a passwordless connection with Service Connector'
description: Create a passwordless connection with Service Connector
author: mcleanbyron
ms.author: mcleans
ms.service: service-connector
ms.topic: tutorial
ms.date: 05/20/2023
ms.devlang: azurecli
ms.custom: passwordless
zone_pivot_group_filename: service-connector/zone-pivot-groups.json
zone_pivot_groups: passwordless
---

# Tutorial: Create a passwordless connection with Service Connector

Passwordless connection use managed identities to access Azure Service. With this approach, you don't have to manually track and manage many different secrets for managed identities because these tasks are securely handled internally by Azure. Service Connector enables managed identities in app hosting services like Azure Spring Apps, Azure App Service, and Azure Container Apps. Service Connector also configures database service, including Azure Database for PostgreSQL, Azure Database for MySQL, Azure SQL database to accept managed identities.
In this tutorial, you'll use the Azure CLI to complete the following tasks:

> [!div class="checklist"]
> * Check your initial environment with the Azure CLI
> * Create passwordless connection with Service Connector
> * Use the environment variable or configurations generated by Service Connect to access database service.

## Prerequisites

* [Azure CLI](/cli/azure/install-azure-cli) version 2.48.1 or higher.
* An Azure account with an active subscription. [Create an Azure account for free](https://azure.microsoft.com/free).
* An app deployed to [Azure Web App](../app-service/overview.md) in a [region supported by Service Connector](./concept-region-support.md).

### Check the environment

#### Azure Active Directory

Service Connector will need to access Azure Active Directory to get information of your account and managed identity of hosting service. You can use the following command to check if your device can access Azure Active Directory.

```azurecli
az ad signed-in-user show
```

If you get a error code `AADSTS530003`, please ask your IT department for help to join this device to Azure Active Directory.


#### Network connectivity

::: zone pivot="postgresql"

If your database server is in Virtual Network, please make sure your environment can access the server in VNet.

::: zone-end

::: zone pivot="mysql"

If your database server is in Virtual Network, please make sure your environment can access the server in VNet.

::: zone-end

::: zone pivot="sql"

If your database disallows public access, please make sure your environment can access the server through private endpoint.

::: zone-end

#### Permissions
The following permissions may be required to create passwordless connection with Service Connector:

::: zone pivot="postgresql"

| Permission | Operation |
| --- | --- |
| Microsoft.DBforPostgreSQL/flexibleServers/read | Required to get information of database server |
| Microsoft.DBforPostgreSQL/flexibleServers/write | Required to enable AAD authentication for database server |
| Microsoft.DBforPostgreSQL/flexibleServers/firewallRules/write | Required to create firewall rule in case the local ip address is blocked |
| Microsoft.DBforPostgreSQL/flexibleServers/firewallRules/delete | Required to revert the firewall rule created by Service Connector to avoid security issue |
| Microsoft.DBforPostgreSQL/flexibleServers/administrators/read | Required to check if Azure CLI login user is a database server AAD administrator |
| Microsoft.DBforPostgreSQL/flexibleServers/administrators/write | Required to add Azure CLI login user as database server AAD administrator |

::: zone-end

::: zone pivot="mysql"

| Permission | Operation |
| --- | --- |
| Microsoft.DBforMySQL/flexibleServers/read | Required to get information of database server |
| Microsoft.DBforMySQL/flexibleServers/write | Required to add the provided user managed identity to database server |
| Microsoft.DBforMySQL/flexibleServers/firewallRules/write | Required to create firewall rule in case the local ip address is blocked |
| Microsoft.DBforMySQL/flexibleServers/firewallRules/delete | Required to revert the firewall rule created by Service Connector to avoid security issue |
| Microsoft.DBforMySQL/flexibleServers/administrators/read | Required to check if Azure CLI login user is a database server AAD administrator |
| Microsoft.DBforMySQL/flexibleServers/administrators/write | Required to add Azure CLI login user as database server AAD administrator |

::: zone-end


::: zone pivot="sql"

| Permission | Operation |
| --- | --- |
| Microsoft.Sql/servers/read | Required to get information of database server |
| Microsoft.Sql/servers/firewallRules/write | Required to create firewall rule in case the local ip address is blocked |
| Microsoft.Sql/servers/firewallRules/delete | Required to revert the firewall rule created by Service Connector to avoid security issue |
| Microsoft.Sql/servers/administrators/read | Required to check if Azure CLI login user is a database server AAD administrator |
| Microsoft.Sql/servers/administrators/write | Required to add Azure CLI login user as database server AAD administrator |

::: zone-end

In some cases the operation is not required, for example, if the CLI login user is already an Active Directory Administrator on the server, then you don't need to have `Microsoft.Sql/servers/administrators/write` permission.

### Install the Service Connector passwordless extension
[!INCLUDE [CLI-samples-clean-up](./install_passwordless_extension.md)]


## Create passwordless connection

Next, we would take Azure App Service as an example. If you use Azure Spring Apps or Azure Container Apps, please replace `webapp` with `spring` or `container` in the following command.

::: zone pivot="postgresql"

### [System managed identity](#tab/system)

```azurecli
az webapp connection create postgres-flexible \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $POSTGRESQL_HOST \
    --database $DATABASE_NAME \
    --system-identity \
    --client-type java
```

### [User managed identity](#tab/user)

```azurecli
az webapp connection create postgres-flexible \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $POSTGRESQL_HOST \
    --database $DATABASE_NAME \
    --user-identity client-id=XX subs-id=XX \
    --client-type java
```

### [Service principal](#tab/sp)

```azurecli
az webapp connection create postgres-flexible \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $POSTGRESQL_HOST \
    --database $DATABASE_NAME \
    --service-principal client-id=XX secret=XX\
    --client-type java
```

As for `--client-type`, you can use `az webapp connection create postgres-flexible -h` to get the supported client types and choose the one which matches your application.


::: zone-end


::: zone pivot="mysql"

Azure Database for MySQL - Flexible Server requires a user-assigned managed identity to enable Azure Active Directory authentication. For more information, see [Set up Azure Active Directory authentication for Azure Database for MySQL - Flexible Server](../mysql/flexible-server/how-to-azure-ad). You can use the following command to create a user-assigned managed identity.

```azurecli
USER_IDENTITY_NAME=<YOUR_USER_ASSIGNED_MANAGEMED_IDENTITY_NAME>
IDENTITY_RESOURCE_ID=$(az identity create \
    --name $USER_IDENTITY_NAME \
    --resource-group $RESOURCE_GROUP \
    --query id \
    --output tsv)
```

> [!IMPORTANT]
> After creating the user-assigned identity, ask your *Global Administrator* or *Privileged Role Administrator* to grant the following permissions for this identity: `User.Read.All`, `GroupMember.Read.All`, and `Application.Read.ALL`. For more information, see the [Permissions](../mysql/flexible-server/concepts-azure-ad-authentication#permissions) section of [Active Directory authentication](../mysql/flexible-server/concepts-azure-ad-authentication).

Then, connect your app to a MySQL database with a system-assigned managed identity using Service Connector.

### [System managed identity](#tab/system)

```azurecli
az webapp connection create mysql-flexible \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $MYSQL_HOST \
    --database $DATABASE_NAME \
    --system-identity mysql-identity-id=$IDENTITY_RESOURCE_ID \
    --client-type java
```

### [User managed identity](#tab/user)

```azurecli
az webapp connection create mysql-flexible \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $MYSQL_HOST \
    --database $DATABASE_NAME \
    --user-identity client-id=XX subs-id=XX mysql-identity-id=$IDENTITY_RESOURCE_ID \
    --client-type java
```

### [Service principal](#tab/sp)

```azurecli
az webapp connection create mysql-flexible \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $MYSQL_HOST \
    --database $DATABASE_NAME \
    --service-principal client-id=XX secret=XX mysql-identity-id=$IDENTITY_RESOURCE_ID \
    --client-type java
```

As for `--client-type`, you can use `az webapp connection create mysql-flexible -h` to get the supported client types and choose the one which matches your application.

::: zone-end


::: zone pivot="sql"

### [System managed identity](#tab/system)

```azurecli
az webapp connection create sql \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $SQL_HOST \
    --database $DATABASE_NAME \
    --system-identity \
    --client-type dotnet
```

### [User managed identity](#tab/user)

```azurecli
az webapp connection create sql \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $SQL_HOST \
    --database $DATABASE_NAME \
    --user-identity client-id=XX subs-id=XX \
    --client-type dotnet
```

### [Service principal](#tab/sp)

```azurecli
az webapp connection create sql \
    --resource-group $RESOURCE_GROUP \
    --name $APPSERVICE_NAME \
    --target-resource-group $RESOURCE_GROUP \
    --server $SQL_HOST \
    --database $DATABASE_NAME \
    --service-principal client-id=XX secret=XX\
    --client-type dotnet
```
As for `--client-type`, you can use `az webapp connection create sql -h` to get the supported client types and choose the one which matches your application.

::: zone-end

This Service Connector command will do the following tasks in the background:

- Enable system-assigned managed identity, or assign a user identity for the app `$APPSERVICE_NAME` hosted by Azure App Service.
- Set the Azure Active Directory admin to the current signed-in user.
- Add a database user for the system-assigned managed identity or user-assigned identity or service principal and grant all privileges of the database `$DATABASE_NAME` to this user. The user name can be get from the connection string in above command output
- Add a connection string to App Settings in the app named `AZURE_MYSQL_CONNECTIONSTRING` or `AZURE_POSTGRESQL_CONNECTIONSTRING` or `AZURE_SQL_CONNECTIONSTRING` based on the database type.

For Azure Spring Apps and Azure Container Apps, the operations are similar.


## Connect to database with Azure Active Directory authentication

After creating the connection, you can use the connection string in your application to connect to the database with Azure Active Directory authentication. For example, you can choose one of the following solutions to connect to the database with Azure Active Directory authentication in Java.

:::zone pivot="postgresql"

1. Update properties file. For more information, see [Quickstart: Use Java and JDBC with Azure Database for PostgreSQL Flexible Server](../postgresql/flexible-server/connect-java?tabs=passwordless#connect-to-the-database)
    ```bash
    cat << EOF > src/main/resources/application.properties
    url=${AZURE_POSTGRESQL_CONNECTIONSTRING}&authenticationPluginClassName=com.azure.identity.extensions.jdbc.postgresql.AzurePostgresqlAuthenticationPlugin
    EOF
    ```
    
    read from properties file and connect to database
    ```java
    Properties properties = new Properties();
    properties.load(DemoApplication.class.getClassLoader().getResourceAsStream("application.properties"));
    Connection connection = DriverManager.getConnection(properties.getProperty("url"));
    ```

2. Directly use the connection string in your application
    ```java
    String url = System.getenv("AZURE_POSTGRESQL_CONNECTIONSTRING");  
    Connection connection = DriverManager.getConnection(url + "&authenticationPluginClassName=com.Azure.identity.extensions.jdbc.postgresql.AzurePostgresqlAuthenticationPlugin");
    ```

For other language, there's not plugin or library for passwordless connection, you can get access token of the managed identity or service principal as the password to connect database. For example, in .NET, you can use [Azure.Identity](https://www.nuget.org/packages/Azure.Identity/) to get access token of managed identity or service principal.

```csharp
// Call managed identities for Azure resources endpoint.
var sqlServerTokenProvider = new DefaultAzureCredential();
string accessToken = (await sqlServerTokenProvider.GetTokenAsync(
    new Azure.Core.TokenRequestContext(scopes: new string[] { "https://ossrdbms-aad.database.windows.net/.default" }) { })).Token;
string connString = String.Format(
                    "Server={0}; User Id={1}; Database={2}; Port={3}; Password={4}; SSLMode=Prefer",
                    Host,
                    User,
                    Database,
                    5432,
                    accessToken);
using (var conn = new NpgsqlConnection(connString))
{
    Console.Out.WriteLine("Opening connection using access token...");
    conn.Open();
    using (var command = new NpgsqlCommand("SELECT version()", conn))
    {
        var reader = command.ExecuteReader();
        while (reader.Read())
        {
            Console.WriteLine("\nConnected!\n\nPostgres version: {0}", reader.GetString(0));
        }
    }
}
```

For more information, see 
* [Bind an Azure Database for PostgreSQL to your application in Azure Spring Apps](../spring-apps/how-to-bind-postgres)
* [Tutorial: Connect to PostgreSQL Database from a Java Quarkus Container App without secrets using a managed identity](../container-apps/tutorial-java-quarkus-connect-managed-identity-postgresql-database)
* [Tutorial: Connect to a PostgreSQL Database from Java Tomcat App Service without secrets using a managed identity](../app-service/tutorial-java-tomcat-connect-managed-identity-postgresql-database)
* 
:::zone-end

:::zone pivot="mysql"

1. Update properties file. For more information, see [Prepare a configuration file to connect to Azure Database for MySQL](../mysql/flexible-server/connect-java?tabs=passwordless#prepare-a-configuration-file-to-connect-to-azure-database-for-mysql)
    ```bash
    cat << EOF > src/main/resources/application.properties
    url=${AZURE_POSTGRESQL_CONNECTIONSTRING}&defaultAuthenticationPlugin=com.azure.identity.extensions.jdbc.mysql.AzureMysqlAuthenticationPlugin&authenticationPlugins=com.azure.identity.extensions.jdbc.mysql.AzureMysqlAuthenticationPlugin
    EOF
    ```
    If you are using MysqlConnectionPoolDataSource class as the datasource in your application, please remove "defaultAuthenticationPlugin=com.Azure.identity.extensions.jdbc.mysql.AzureMysqlAuthenticationPlugin" in the url.

    Next, read from properties file and connect to database
    ```java
    Properties properties = new Properties();
    properties.load(DemoApplication.class.getClassLoader().getResourceAsStream("application.properties"));
    Connection connection = DriverManager.getConnection(properties.getProperty("url"));
    ```

2. Directly use the connection string in your application
    ```java
    String url = System.getenv("AZURE_MYSQL_CONNECTIONSTRING");  
    Connection connection = DriverManager.getConnection(url + "&defaultAuthenticationPlugin=com.azure.identity.extensions.jdbc.mysql.AzureMysqlAuthenticationPlugin&authenticationPlugins=com.azure.identity.extensions.jdbc.mysql.AzureMysqlAuthenticationPlugin");
    ```

For other language, there's not plugin or library for passwordless connection, you can get access token of the managed identity or service principal as the password to connect database. For example, in .NET, you can use [Azure.Identity](https://www.nuget.org/packages/Azure.Identity/) to get access token of managed identity or service principal.

```csharp
HttpWebRequest request = (HttpWebRequest)WebRequest.Create("http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https%3A%2F%2Fossrdbms-aad.database.windows.net");
request.Headers["Metadata"] = "true";
request.Method = "GET";
string accessToken = null;

try
{
    // Call managed identities for Azure resources endpoint.
    HttpWebResponse response = (HttpWebResponse)request.GetResponse();

    // Pipe response Stream to a StreamReader and extract access token.
    StreamReader streamResponse = new StreamReader(response.GetResponseStream());
    string stringResponse = streamResponse.ReadToEnd();
    var list = JsonSerializer.Deserialize<Dictionary<string, string>>(stringResponse);
    accessToken = list["access_token"];
}
catch (Exception e)
{
    Console.Out.WriteLine("{0} \n\n{1}", e.Message, e.InnerException != null ? e.InnerException.Message : "Acquire token failed");
    System.Environment.Exit(1);
}
//
// Open a connection to the MySQL server using the access token.
//
var builder = new MySqlConnectionStringBuilder
{
    Server = Host,
    Database = Database,
    UserID = User,
    Password = accessToken,
    SslMode = MySqlSslMode.Required,
};

using (var conn = new MySqlConnection(builder.ConnectionString))
{
    Console.Out.WriteLine("Opening connection using access token...");
    await conn.OpenAsync();

    using (var command = conn.CreateCommand())
    {
        command.CommandText = "SELECT VERSION()";

        using (var reader = await command.ExecuteReaderAsync())
        {
            while (await reader.ReadAsync())
            {
                Console.WriteLine("\nConnected!\n\nMySQL version: {0}", reader.GetString(0));
            }
        }
    }
}
```

For more information, see 
* [Connect an Azure Database for MySQL instance to your application in Azure Spring Apps](../spring-apps/how-to-bind-mysql)


:::zone-end


:::zone pivot="sql"

### [System managed identity](#tab/system)

For managed identity authentication, see [Using Active Directory Managed Identity authentication](/sql/connect/ado-net/sql/azure-active-directory-authentication?view=sql-server-ver16#using-active-directory-managed-identity-authentication)

```csharp
// The connection string should have been set to environment variables by Service Connector
// string ConnectionString1 = @"Server=demo.database.windows.net; Authentication=Active Directory Managed Identity; Encrypt=True; Database=testdb";
string ConnectionString1 = Environment.GetEnvironmentVariable("AZURE_SQL_CONNECTIONSTRING");  
using (SqlConnection conn = new SqlConnection(ConnectionString1)) {
    conn.Open();
}

```

### [User managed identity](#tab/user)

For managed identity authentication, see [Using Active Directory Managed Identity authentication](/sql/connect/ado-net/sql/azure-active-directory-authentication?view=sql-server-ver16#using-active-directory-managed-identity-authentication)

```csharp
// The connection string should have been set to environment variables by Service Connector
// string ConnectionString1 = @"Server=demo.database.windows.net; Authentication=Active Directory Managed Identity; Encrypt=True; User Id=ObjectIdOfManagedIdentity; Database=testdb";
string ConnectionString1 = Environment.GetEnvironmentVariable("AZURE_SQL_CONNECTIONSTRING");  
using (SqlConnection conn = new SqlConnection(ConnectionString1)) {
    conn.Open();
}

```

### [Service principal](#tab/service)
For Service principal authentication, see [Using Active Directory Service Principal authentication](/sql/connect/ado-net/sql/azure-active-directory-authentication?view=sql-server-ver16#using-active-directory-service-principal-authentication)

```csharp
// The connection string should have been set to environment variables by Service Connector
// string ConnectionString = @"Server=demo.database.windows.net; Authentication=Active Directory Service Principal; Encrypt=True; Database=testdb; User Id=AppId; Password=secret";
string ConnectionString1 = Environment.GetEnvironmentVariable("AZURE_SQL_CONNECTIONSTRING");  
using (SqlConnection conn = new SqlConnection(ConnectionString1)) {
    conn.Open();
}

```

For more information, see this site [Homepage for client programming to Microsoft SQL Server](/sql/connect/homepage-sql-connection-programming)


:::zone-end


## Deploy the application code to Azure hosting services

For Azure App Service, you can deploy the application code by `az webapp deploy` command, see more [Quickstart: Deploy an ASP.NET web app](../app-service/quickstart-dotnetcore.md)

For Azure Spring Apps, you can deploy the application code by `az spring-cloud app deploy` command, see more [Quickstart: Deploy your first application to Azure Spring Apps](../spring-apps/quickstart.md)

For Azure Container Apps, you can deploy the application code by `az containerapp create` command, see more [Quickstart: Deploy your first container app with containerapp up](../container-apps/get-started.md)

Then you can check the log or call the application to see if it can connect to database on Azure successfully.

## Next steps

Check the sites below for more information about Service Connector and passwordless connection:

> [!div class="nextstepaction"]
> [Service Connector documentation](/azure/service-connector/)

> [!div class="nextstepaction"]
> [Passwordless connections for Azure services](/azure/developer/intro/passwordless-overview)
